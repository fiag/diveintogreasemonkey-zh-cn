<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
"../docbook/dtd/docbookx.dtd"
[
<!ENTITY % entities_version SYSTEM "version.xml">
%entities_version;
<!ENTITY gpl SYSTEM "gpl.xml">
<!ENTITY gm_minversion "0.3">
<!ENTITY title "Dive Into Greasemonkey">
<!ENTITY url_book "http://diveintogreasemonkey.org/">
<!ENTITY url_stylesheet "&url_book;css/dig.css">
<!ENTITY url_videos "../videos/">
<!ENTITY url_images "../images/">
<!ENTITY xml "<acronym condition='Extensible Markup Language'>XML</acronym>">
<!ENTITY xsl "<acronym condition='Extensible Stylesheet Language'>XSL</acronym>">
<!ENTITY html "<acronym condition='HyperText Markup Language'>HTML</acronym>">
<!ENTITY xhtml "<acronym condition='Extensible HyperText Markup Language'>XHTML</acronym>">
<!ENTITY http "<acronym condition='Hypertext Transfer Protocol'>HTTP</acronym>">
<!ENTITY rest "<acronym condition='Representational State Transfer'>REST</acronym>">
<!ENTITY ftp "<acronym condition='File Transfer Protocol'>FTP</acronym>">
<!ENTITY ascii "ASCII">
<!ENTITY pdf "<acronym condition='Portable Document Format'>PDF</acronym>">
<!ENTITY https "<acronym>HTTPS</acronym>">
<!ENTITY mime "<acronym>MIME</acronym>">
<!ENTITY css "<acronym condition='Cascading Style Sheets'>CSS</acronym>">
<!ENTITY rfc "<acronym condition='Request For Comments'>RFC</acronym>">
<!ENTITY uri "<acronym condition='Uniform Resource Identifier'>URI</acronym>">
<!ENTITY url "<acronym condition='Uniform Resource Locator'>URL</acronym>">
<!ENTITY msdn "<acronym condition='Microsoft Developer Network'>MSDN</acronym>">
<!ENTITY docbook "<application>DocBook</application>">
<!ENTITY emacs "<application>Emacs</application>">
<!ENTITY w3m "<application>w3m</application>">
<!ENTITY htmldoc "<application>HTMLDoc</application>">
<!ENTITY saxon "<application>SAXON</application>">
<!ENTITY onclick "<systemitem class='event'>onclick</systemitem>">
<!ENTITY click "<systemitem class='event'>click</systemitem>">
<!ENTITY submit "<systemitem class='event'>submit</systemitem>">
<!ENTITY onload "<systemitem class='event'>onload</systemitem>">
<!ENTITY onerror "<systemitem class='event'>onerror</systemitem>">
<!ENTITY onreadystatechange "<systemitem class='event'>onreadystatechange</systemitem>">

<!ENTITY url_docbook "http://wiki.docbook.org/topic/DocBook">
<!ENTITY url_docbookxsl "http://docbook.sourceforge.net/projects/xsl/index.html">
<!ENTITY url_docbook_tdg "http://www.docbook.org/tdg/en/html/docbook.html">
<!ENTITY url_docbook_lists "http://www.oasis-open.org/docbook/mailinglist/">
<!ENTITY url_emacs "http://www.gnu.org/software/emacs/emacs.html">
<!ENTITY url_saxon "http://saxon.sourceforge.net/">
<!ENTITY url_htmldoc "http://www.easysw.com/htmldoc/">
<!ENTITY url_w3m "http://w3m.sourceforge.net/">
<!ENTITY url_mozbehaviors "http://dean.edwards.name/my/behaviors/#js-highlight.htc">
<!ENTITY url_greasemonkey "http://greasemonkey.mozdev.org/">
<!ENTITY url_greasemonkeyrepository "http://dunck.us/collab/GreaseMonkeyUserScripts">
<!ENTITY url_greasemonkeymailinglist "http://greasemonkey.mozdev.org/list.html">
<!ENTITY url_mozilla_xpath_documentation "http://www-jcsu.jesus.cam.ac.uk/~jg307/mozilla/xpath-tutorial.html">
<!ENTITY url_zvon_xpath_tutorial "http://www.zvon.org/xxl/XPathTutorial/General/examples.html">
<!ENTITY url_data_uri_kitchen "http://software.hixie.ch/utilities/cgi/data/data">
<!ENTITY url_jsanonymousfunctions "http://novemberborn.net/sifr/explained/terminology">
<!ENTITY url_jsblockscope "http://youngpup.net/2004/jsblockscope">
<!ENTITY url_jsblockscope_comments "http://youngpup.net/2004/jsblockscope/comments">
<!ENTITY url_google "http://www.google.com/">
<!ENTITY url_froogle "http://froogle.google.com/">
<!ENTITY url_gmail "http://gmail.google.com/">
<!ENTITY url_gmailhttps "https://gmail.google.com/">
<!ENTITY url_adblock "http://adblock.mozdev.org/">
<!ENTITY url_adblock_filterlist "http://www.geocities.com/pierceive/adblock/">
<!ENTITY url_jseventcompatibility "http://www.quirksmode.org/js/events_compinfo.html">
<!ENTITY url_jsdomprototypes "http://www.mozilla.org/docs/dom/mozilla/protodoc.html">
<!ENTITY url_eventobjects "http://www.mozilla.org/docs/dom/domref/examples.html#999002">
<!ENTITY url_bloglines "http://www.bloglines.com/">
<!ENTITY url_diveintoaccesskeys "http://diveintoaccessibility.org/day_15_defining_keyboard_shortcuts.html">
<!ENTITY url_xpathresult_reference "http://www.xulplanet.com/references/objref/XPathResult.html">
<!ENTITY url_taguri "http://taguri.org/">
<!ENTITY url_greasemonkeycompiler "http://www.letitblog.com/greasemonkey-compiler/">
<!ENTITY url_cssproperties "http://www.westciv.com/style_master/academy/css_tutorial/properties/">
<!ENTITY url_webdeveloperextension "http://chrispederick.com/work/firefox/webdeveloper/">
<!ENTITY url_aardvarkextension "http://www.karmatics.com/aardvark/">
<!ENTITY url_venkmandebugger "http://www.hacksrus.com/~ginda/venkman/">
<!ENTITY url_jessebookmarklets "http://www.squarefree.com/bookmarklets/webdevel.html">
<!ENTITY url_jsunit "http://www.edwardh.com/jsunit/">
<!ENTITY url_jslint "http://www.crockford.com/javascript/lint.html">
<!ENTITY url_domi_intro "http://www.brownhen.com/DI.html">
<!ENTITY url_inspectelementextension "https://addons.update.mozilla.org/extensions/moreinfo.php?id=434">
<!ENTITY url_inspectorwidget "http://www.projectit.com/freestuff.html">
<!ENTITY url_camstudio "http://www.swftools.com/tools-details.php?tool=8162413051">
<!ENTITY url_swftools "http://www.quiss.org/swftools/">
<!ENTITY url_ant "http://ant.apache.org/">
<!ENTITY url_greaseblog "http://greaseblog.blogspot.com/">
<!ENTITY url_greaseblog_feed "&url_greaseblog;atom.xml">
<!ENTITY url_httpstatuscodes "http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">
<!ENTITY url_rfc2616 "http://www.w3.org/Protocols/rfc2616/rfc2616.html">
<!ENTITY url_mozillaxmlhttprequest "http://www.xulplanet.com/references/objref/XMLHttpRequest.html">
<!ENTITY url_safarixmlhttprequest "http://developer.apple.com/internet/webcontent/xmlhttpreq.html">
<!ENTITY url_iexmlhttprequest "http://msdn.microsoft.com/library/default.asp?url=/library/en-us/xmlsdk/html/xmobjpmexmlhttprequest.asp">
<!ENTITY url_aintitcoolnews "http://aint-it-cool-news.com/">
<!ENTITY url_plucker "http://www.plkr.org/">
<!ENTITY url_tmpgenc "http://www.tmpgenc.net/">
<!ENTITY url_event_docs "http://www.xulplanet.com/references/objref/Event.html">
<!ENTITY url_msdn_language_filter "http://blog.monstuff.com/archives/images/MSDNLanguageFilter.user.js">
<!ENTITY url_mypipstag "http://dunck.us/code/greasemonkey/mypipstag.user.js">
<!ENTITY url_post_interceptor "http://kailasa.net/prakash/greasemonkey/post-interceptor.user.js">
<!ENTITY url_librarylookup "http://weblog.infoworld.com/udell/gems/LibraryLookup.user.js">
<!ENTITY url_annotate_google "http://ponderer.org/download/annotate_google.user.js">
<!ENTITY url_amazon "http://www.amazon.com/">
<!ENTITY url_delicious "http://del.icio.us/">
<!ENTITY url_bloglines_tweaks "http://persistent.info/greasemonkey/bloglines.user.js">
<!ENTITY url_bloglines "http://www.bloglines.com/">
<!ENTITY url_flick_batch "http://lachnlone.no-ip.info/greasemonkey/flick_batch.user.js">
<!ENTITY url_flickr "http://www.flickr.com/">
<!ENTITY url_hide_google_redirects "http://www.cs.toronto.edu/~james/greasemonkey/hide-google-redirects.user.js">
<!ENTITY url_google_searchhistory "http://www.google.com/searchhistory/">
<!ENTITY url_greasemonkey_compiler "http://www.letitblog.com/greasemonkey-compiler/">
<!ENTITY url_guid_generator "http://extensions.roachfiend.com/cgi-bin/guid.pl">
<!ENTITY url_7zip "http://www.7-zip.org/">
<!ENTITY url_stuffit "http://www.stuffit.com/">
<!ENTITY url_extension_developers_extension "http://ted.mielczarek.org/code/mozilla/extensiondev/">

<!ENTITY url_example "&url_book;download/">
<!ENTITY url_butlerhomepage "http://diveintomark.org/projects/butler/">
<!ENTITY url_example_butler "&url_butlerhomepage;butler.user.js">
<!ENTITY butlerversion "0.3">
<!ENTITY url_example_accessbar "&url_example;accessbar.user.js">
<!ENTITY url_example_aintitreadable "&url_example;aintitreadable.user.js">
<!ENTITY url_example_antidisabler "&url_example;antidisabler.user.js">
<!ENTITY url_example_betterdir "&url_example;betterdir.user.js">
<!ENTITY url_example_blogdexdisplaytitle "&url_example;blogdex-display-title.user.js">
<!ENTITY url_example_bloglinesautoload "&url_example;bloglines-autoload.user.js">
<!ENTITY url_example_cdreadable "&url_example;cdreadable.user.js">
<!ENTITY url_example_dumbquotes "&url_example;dumbquotes.user.js">
<!ENTITY url_example_forceget "&url_example;forceget.user.js">
<!ENTITY url_example_frownies "&url_example;frownies.user.js">
<!ENTITY url_example_gmailsecure "&url_example;gmailsecure.user.js">
<!ENTITY url_example_helloworld "&url_example;helloworld.user.js">
<!ENTITY url_example_lip "&url_example;lip.user.js">
<!ENTITY url_example_offsiteblank "&url_example;offsiteblank.user.js">
<!ENTITY url_example_rottenreviews "&url_example;rottenreviews.user.js">
<!ENTITY url_example_rottenskip "&url_example;rottenskip.user.js">
<!ENTITY url_example_salonautopass "&url_example;salonautopass.user.js">
<!ENTITY url_example_stopthepresses "&url_example;stopthepresses.user.js">
<!ENTITY url_example_gmlog "&url_example;gmlog.user.js">
<!ENTITY url_example_unstyle "&url_example;unstyle.user.js">
<!ENTITY url_example_zoomtextarea "&url_example;zoomtextarea.user.js">

<!ENTITY url_download "&url_example;">
<!ENTITY projectname "diveintogreasemonkey">
<!ENTITY preferredext ".zip">
<!ENTITY url_download_xml "&url_download;&projectname;-&fileversion;-xml&preferredext;">
]>

<book lang="en">
<?dbhtml filename="toc/index.html"?>
<title>&title;</title>
<bookinfo>
<title>&title;</title>
<authorgroup>
<author>
<firstname>Mark</firstname>
<surname>Pilgrim</surname>
</author>
</authorgroup>
<copyright>
<year>2005</year>
<holder>Mark Pilgrim</holder>
</copyright>
<pubdate>&fileversion;</pubdate>
<abstract>
<title/>
<para>This book lives at <ulink url="&url_book;"/>.  If you're reading it somewhere else, you may not have the latest version.</para>
</abstract>
<keywordset>
<keyword>Firefox</keyword>
<keyword>Greasemonkey</keyword>
<keyword>Javascript</keyword>
<keyword>user script</keyword>
<keyword>userscript</keyword>
</keywordset>
<revhistory>
<revision>
<revnumber>2005-05-09</revnumber>
<date>2005-05-09</date>
<revdescription>
<itemizedlist>
<listitem><para>Added <xref linkend="casestudy.zoomtextarea"/>.</para></listitem>
<listitem><para>Added <xref linkend="advanced.getvalue"/>.</para></listitem>
<listitem><para>Added <xref linkend="advanced.registermenucommand"/>.</para></listitem>
<listitem><para>Added <xref linkend="advanced.xmlhttprequest"/>.</para></listitem>
<listitem><para>Added <xref linkend="advanced.compiler"/>.</para></listitem>
</itemizedlist>
</revdescription>
</revision>
<revision>
<revnumber>2005-05-06</revnumber>
<date>2005-05-06</date>
<revdescription>
<itemizedlist>
<listitem><para>Added <xref linkend="casestudy.frownies"/>.</para></listitem>
<listitem><para>Changed <constant>void</constant> to <constant>function</constant> in <xref linkend="api"/>.  (<quote>You keep using that word.  I do not think it means what you think it means.</quote>)</para></listitem>
</itemizedlist>
</revdescription>
</revision>
<revision>
<revnumber>2005-05-05</revnumber>
<date>2005-05-05</date>
<revdescription>
<itemizedlist>
<listitem><para>Added <xref linkend="basic.what"/>.  Thanks, Dennis.</para></listitem>
<listitem><para>Added <xref linkend="casestudy.dumbquotes"/>.</para></listitem>
<listitem><para>Added downloadable Palm OS&trade; database for reading on mobile devices.</para></listitem>
</itemizedlist>
</revdescription>
</revision>
<revision>
<revnumber>2005-05-04</revnumber>
<date>2005-05-04</date>
<revdescription>
<itemizedlist>
<listitem><para>Added <xref linkend="pattern.parsexml"/>.</para></listitem>
<listitem><para>Added <xref linkend="casestudy.offsiteblank"/>.</para></listitem>
</itemizedlist>
</revdescription>
</revision>
<revision>
<revnumber>2005-05-03</revnumber>
<date>2005-05-03</date>
<revdescription>
<itemizedlist>
<listitem><para>Compressed videos further.</para></listitem>
<listitem><para>Added videos to downloadable &html; distribution.</para></listitem>
</itemizedlist>
</revdescription>
</revision>
<revision>
<revnumber>2005-05-02</revnumber>
<date>2005-05-02</date>
<revdescription>
<itemizedlist>
<listitem><para>Added <xref linkend="api.gmxmlhttprequest"/>.</para></listitem>
<listitem><para>Added <xref linkend="casestudy.aintitreadable"/>.</para></listitem>
<listitem><para>Refactored <ulink url="&url_example_offsiteblank;">Offsite Blank</ulink>.</para></listitem>
<listitem><para>Updated code examples to Greasemonkey 0.3 format.</para></listitem>
</itemizedlist>
</revdescription>
</revision>
<revision>
<revnumber>2005-05-01</revnumber>
<date>2005-05-01</date>
<revdescription>
<itemizedlist>
<listitem><para>Added <xref linkend="api"/>.</para></listitem>
<listitem><para>Incorporated copious feedback from Simon Willison.  Thanks, Simon.</para></listitem>
<listitem><para>Incorporated copious feedback from Jeremy Dunck.  Thanks, Jeremy.</para></listitem>
</itemizedlist>
</revdescription>
</revision>
<revision>
<revnumber>2005-04-30</revnumber>
<date>2005-04-30</date>
<revdescription>
<itemizedlist>
<listitem><para>Added <xref linkend="basic"/>.</para></listitem>
<listitem><para>Added <xref linkend="first"/>.</para></listitem>
<listitem><para>Added <xref linkend="debug"/>.</para></listitem>
<listitem><para>Added <link linkend="procedures">videos</link> (currently online only).</para></listitem>
</itemizedlist>
</revdescription>
</revision>
<revision>
<revnumber>2005-04-25</revnumber>
<date>2005-04-25</date>
<revdescription>
<itemizedlist>
<listitem><para>Initial publication</para></listitem>
</itemizedlist>
</revdescription>
</revision>
</revhistory>
<legalnotice>
<para>This book, its sample code, and its supplementary videos are free software. You can redistribute them and/or modify them under the terms of the GNU General Public License as published by the Free Software Foundation, either version 2 of the License or (at your option) any later version. This book, its sample code, and its supplementary videos are distributed in the hope that they will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the <xref linkend="license"/> for more details.</para>
</legalnotice>
</bookinfo>

<chapter id="basic">
<?dbhtml filename="install/index.html"?>
<title>Getting Started</title>

<section id="basic.what">
<?dbhtml filename="install/what-is-greasemonkey.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Greasemonkey is a Firefox extension that allows you to write scripts that alter the web pages you visit.  You can use it to make a web site more readable or more usable.  You can fix rendering bugs that the site owner can't be bothered to fix themselves.  You can alter pages so they work better with assistive technologies that speak a web page out loud or convert it to Braille.  You can even automatically retrieve data from other sites to make two sites more interconnected.</para>
</abstract>
</sectioninfo>
<title>What is Greasemonkey?</title>
<para>Greasemonkey by itself does none of these things.  In fact, after you install it, you won't notice any change at all... until you start installing what are called <quote>user scripts</quote>.  A user script is just a chunk of Javascript code, with some additional information that tells Greasemonkey where and when it should be run.  Each user script can target a specific page, a specific site, or a group of sites.  A user script can do anything you can do in Javascript.  In fact, it can do even more than that, because Greasemonkey provides special functions that are only available to user scripts.</para>
<para>There is a <ulink url="&url_greasemonkeyrepository;">Greasemonkey script repository</ulink> that contains hundreds of user scripts that people have written to scratch their own personal itches.  Once you write your own user script, you can add it to the repository if you think others might find it useful.  Or you can keep it to yourself, content in the knowledge that you've made your own browsing experience is a little better.</para>
<para>There is also a <ulink url="&url_greasemonkeymailinglist;">Greasemonkey mailing list</ulink>, where you can ask questions, announce user scripts, and discuss ideas for new features.  The Greasemonkey developers frequent the list; they may even answer your question!</para>
<bridgehead renderas="sect3">Why this book?</bridgehead>
<para>&title; grew out of discussions on the Greasemonkey mailing list, and out of my own experience in writing user scripts.  After only a week on the list, I was already seeing questions from new users that had already been answered.  With only a few user scripts under my belt, I was already seeing common patterns, chunks of reusable code that solved specific problems that cropped up again and again.  I set out to document the most useful patterns, explain my own coding decisions, and learn as much as I could in the process.</para>
<para>This book would not be half as good as it is today without the help of the Greasemonkey developers, Aaron Boodman and Jeremy Dunck, and the rest of the people who provided invaluable feedback on my early drafts.  Thank you all.</para>

</section>

<section id="basic.installgm">
<?dbhtml filename="install/greasemonkey.html"?>
<sectioninfo>
<abstract>
<title/>
<para>To start writing user scripts, you first need to install the Greasemonkey browser extension, version &gm_minversion; or later.</para>
</abstract>
</sectioninfo>
<title>Installing Greasemonkey</title>
<procedure id="procedure.install.greasemonkey">
<title>Install the Greasemonkey extension</title>
<step><para>Visit the <ulink url="&url_greasemonkey;">Greasemonkey home page</ulink>.</para></step>
<step><para>Click the link titled <guilabel role="hyperlink">Install Greasemonkey</guilabel>.</para></step>
<step><para>Firefox will indicate (probably at the top of your browser window) that it prevented the site from installing software.  Click <guibutton>Edit options...</guibutton> to bring up the <interface role="windowtitle">Allowed Sites</interface> dialog, then click <guibutton>Allow</guibutton> to add the Greasemonkey site to your list of sites that are allowed to install software.  Click <guibutton>OK</guibutton> to close the <interface role="windowtitle">Allowed Sites</interface> dialog.</para></step>
<step><para>Once again, click the link titled <guilabel role="hyperlink">Install Greasemonkey</guilabel>.</para></step>
<step><para>Now an install dialog should pop up to confirm that you really want to install.  Wait a few seconds for the install button to enable, then click <guibutton>Install now</guibutton>.</para>
<screenshot id="screenshot.install.greasemonkey">
<screeninfo>[screenshot of Software Installation dialog]</screeninfo>
<graphic fileref="&url_images;install-gm.jpg"/>
</screenshot>
</step>
<step><para>Restart your browser.</para></step>
</procedure>
<para>Once you restart your browser, select the <menuchoice><guimenu><accel>T</accel>ools</guimenu></menuchoice> menu.  You should see three new menu items: <menuchoice><guimenuitem>Install User <accel>S</accel>cript...</guimenuitem></menuchoice>, <menuchoice><guimenuitem>Manage <accel>U</accel>ser Scripts...</guimenuitem></menuchoice>, and <menuchoice><guimenuitem>User Script <accel>C</accel>ommands</guimenuitem></menuchoice>.  Only <menuchoice><guimenuitem>Manage <accel>U</accel>ser Scripts...</guimenuitem></menuchoice> will be enabled, but that's OK.  The others only become enabled under special circumstances.</para>
<para>By default, installing Greasemonkey does not add any functionality to your browser (other than those three menu items).  All it does it enable you to install additional items, called <quote>user scripts</quote>, which customize specific web pages.</para>
</section> <!-- basic.installgm -->

<section id="basic.installscript">
<?dbhtml filename="install/userscript.html"?>
<sectioninfo>
<abstract>
<title/>
<para>A Greasemonkey <quote>user script</quote> is a single file, written in Javascript, that customizes one or more web pages.</para>
</abstract>
</sectioninfo>
<title>Installing a user script</title>
<tip>
<title/>
<para>Many user scripts are available at the <ulink url="&url_greasemonkeyrepository;">Greasemonkey script repository</ulink>, although there is no requirement to list your scripts there.  You may host (and users may install) your script from anywhere.  You don't even need a web server; you can install a user script from a local file.</para>
</tip>
<note>
<title/>
<para>A user script's filename must end in <filename>.user.js</filename>.</para>
</note>
<para>The first user script I wrote was called <quote>Butler</quote>.  It adds functionality to Google search results.</para>
<procedure id="procedure.install.butler">
<title>Install the Butler user script</title>
<mediaobject>
<videoobject><videodata fileref="&url_videos;install-user-script.swf" format="SWF"/></videoobject>
<textobject><phrase>Watch the video: <ulink url="&url_videos;install-user-script.html">how to install a user script</ulink>.</phrase></textobject>
</mediaobject>
<step><para>Visit the <ulink url="&url_butlerhomepage;">Butler home page</ulink> to see a brief description of the functionality that Butler offers.  (Not all user scripts have home pages; the only thing Greasemonkey cares about is the script itself.)</para></step>
<step><para>Click the link titled <guilabel role="hyperlink">Download version...</guilabel> (&butlerversion; as of this writing), and you will see the script itself in your browser.  It is several pages long.</para></step>
<step><para>In the <guimenu><accel>T</accel>ools</guimenu> menu, the <guimenuitem>Install User <accel>S</accel>cript...</guimenuitem> item should now be enabled.  Select it.</para></step>
<step><para>A dialog will pop up titled <interface role="windowtitle">Install User Script</interface>, which displays the name of the script you are about to install, a brief description, and a list of included and excluded pages.  All of this information is taken from the script itself; you'll learn how to define it in <xref linkend="first.metadata"/>.</para></step>
<step><para>Click <guibutton>OK</guibutton> to install the user script.</para></step>
</procedure>
<para>If all went well, Greasemonkey will pop up an alert saying <guilabel>Success!  Refresh page to see changes.</guilabel></para>
<para>Now, search for something in <ulink url="&url_google;">Google</ulink>.  In the search results page, there is a line at the top of the results that says <guilabel>Try your search on: Yahoo, Ask Jeeves, AlltheWeb, ...</guilabel>.  There is also a banner along the top that says <guilabel>Enhanced by Butler</guilabel>.  All of these were added by the Butler user script.</para>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_greasemonkeyrepository;">Greasemonkey script repository</ulink> contains hundreds of Greasemonkey scripts.</para></listitem>
</itemizedlist>
</section> <!-- basic.installscript -->

<section id="basic.manage">
<?dbhtml filename="install/manage.html"?>
<sectioninfo>
<abstract>
<title/>
<para>You can install as many Greasemonkey scripts as you like.  Greasemonkey has a graphical configuration dialog to manage your user scripts: disable them temporarily, change their configuration, or uninstall them completely.</para>
</abstract>
</sectioninfo>
<title>Managing your user scripts</title>
<procedure id="procedure.manage.userscripts">
<title>Disable Butler temporarily</title>
<mediaobject>
<videoobject><videodata fileref="&url_videos;disable-user-script.swf" format="SWF"/></videoobject>
<textobject><phrase>Watch the video: <ulink url="&url_videos;disable-user-script.html">how to disable a user script</ulink>.</phrase></textobject>
</mediaobject>
<step><para>From the menu, select <menuchoice><guimenu><accel>T</accel>ools</guimenu><guimenuitem>Manage <accel>U</accel>ser Scripts...</guimenuitem></menuchoice>.  Greasemonkey will pop up a dialog titled <interface role="windowtitle">Manage User Scripts</interface>.</para></step>
<step><para>In the left-hand pane of the dialog is a list of all the user scripts you have installed.  (If you've been <link linkend="basic.installscript">following along from the beginning</link>, then this will be just one script: Butler.)</para></step>
<step><para>Select Butler in the list if it is not already selected, and deselect the <guibutton>Enabled</guibutton> checkbox.  The color of <guilabel>Butler</guilabel> in the left-hand pane should change subtly from black to gray.  (This is difficult to see while it is still selected, but more useful once you have dozens of scripts installed.)</para></step>
<step><para>Click <guibutton>OK</guibutton> to exit the <interface role="windowtitle">Manage User Scripts</interface> dialog.</para></step>
</procedure>
<para>Now Butler is installed, but inactive.  You can verify this by searching for something on Google.  It should no longer say <guilabel>Enhanced by Butler</guilabel> along the top.  You can re-enable Butler by repeating the procedure and re-selecting the <guibutton>Enabled</guibutton> checkbox in the <interface role="windowtitle">Manage User Scripts</interface> dialog.</para>
<note>
<title/>
<para>Although I refer to disabling a user script as <quote>temporary</quote>, it will remain disabled until you explicitly re-enable it.  The only thing that's really temporary about it is that you can easily re-enable it without having to find the original script on my web site and re-install it.</para>
</note>
<para>You can also use the <interface role="windowtitle">Manage User Scripts</interface> dialog to uninstall scripts entirely.</para>
<procedure id="procedure.uninstall.userscript">
<title>Uninstall Butler</title>
<mediaobject>
<videoobject><videodata fileref="&url_videos;uninstall-user-script.swf" format="SWF"/></videoobject>
<textobject><phrase>Watch the video: <ulink url="&url_videos;uninstall-user-script.html">how to uninstall a user script</ulink>.</phrase></textobject>
</mediaobject>
<step><para>From the menu, select <menuchoice><guimenu><accel>T</accel>ools</guimenu><guimenuitem>Manage <accel>U</accel>ser Scripts...</guimenuitem></menuchoice>.  Greasemonkey will pop up the <interface role="windowtitle">Manage User Scripts</interface> dialog.</para></step>
<step><para>In the left-hand pane, select Butler and click <guibutton>Uninstall</guibutton>.  There is no confirmation; the user script is immediately uninstalled.</para></step>
<step><para>Step 3... There is no step 3!  (With apologies to Jeff Goldblum.)</para></step>
</procedure>
<para>But wait, there's more!  You can also change the configuration of user scripts you have previously installed.  Do you remember <link linkend="basic.installscript">that dialog you got when you first installed Butler</link>, the one that had the two lists of sites to include and exclude?  Well, you can change those parameters yourself, either at install time, or at any time in the <interface role="windowtitle">Manage User Scripts</interface> dialog.</para>
<para>Let's say, for example, that you like Butler, but you have no use for it on <ulink url="&url_froogle;">Froogle</ulink>, Google's product comparison site.  You can modify the user script configuration to exclude that site, but still let it work on other Google sites.</para>
<procedure id="procedure.reconfigure.userscript">
<title>Reconfigure Butler to leave Froogle alone</title>
<mediaobject>
<videoobject><videodata fileref="&url_videos;exclude-pages.swf" format="SWF"/></videoobject>
<textobject><phrase>Watch the video: <ulink url="&url_videos;exclude-pages.html">how to reconfigure a user script</ulink>.</phrase></textobject>
</mediaobject>
<step><para>From the menu, select <menuchoice><guimenu><accel>T</accel>ools</guimenu><guimenuitem>Manage <accel>U</accel>ser Scripts...</guimenuitem></menuchoice>.  Greasemonkey will pop up the <interface role="windowtitle">Manage User Scripts</interface> dialog.</para></step>
<step><para>In the left-hand pane, select <guilabel>Butler</guilabel>.  In the right-hand pane, it should show you two lists, one of included pages (<guilabel>http://*.google.*/*</guilabel>) and one of excluded pages (blank).</para></step>
<step><para>Next to the <guilabel>Excluded pages</guilabel> list, click <guibutton>Add...</guibutton>.</para></step>
<step><para>Greasemonkey will pop up a secondary dialog titled <interface role="windowtitle">Add Page</interface> and prompt you to enter a new &url;.  Enter <userinput>&url_froogle;*</userinput> and click <guibutton>OK</guibutton>.</para></step>
<step><para>Back in the <interface role="windowtitle">Manage User Scripts</interface> dialog, the excluded pages list should now include your new &url; wildcard, <userinput>&url_froogle;*</userinput>, meaning that Butler will <emphasis>not</emphasis> be executed on any page of the <systemitem class="domainname">froogle.google.com</systemitem> site.  The asterisk serves as a simple wildcard, and you may use it within any part of the &url;: domain name, path, or even within the &url; scheme (<systemitem>http://</systemitem>).</para></step>
<step><para>Click <guibutton>OK</guibutton> to exit the <interface role="windowtitle">Manage User Scripts</interface> dialog and search for a product on Froogle to verify that Butler is no longer being executed.  It should still be executed on normal web search results, image search results, and other Google sites.</para></step>
</procedure>
</section> <!-- basic.manage -->

</chapter> <!-- basic -->

<chapter id="first">
<?dbhtml filename="helloworld/index.html"?>
<title>Your First User Script</title>

<section id="first.divein">
<?dbhtml filename="helloworld/divein.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Our hundred-mile-long journey into the wonderful world of Greasemonkey scripting begins with a single step, and it is a step familiar to all readers of technical manuals: getting your computer to print out <guilabel>Hello world</guilabel>.</para>
</abstract>
</sectioninfo>
<title>Hello World</title>
<example id="example.helloworld.code">
<title><ulink url="&url_example_helloworld;"><filename>helloworld.user.js</filename></ulink></title>
<programlisting><![CDATA[// Hello World! example user script
// version 0.1 BETA!
// 2005-04-22
// Copyright (c) 2005, Mark Pilgrim
// Released under the GPL license
// http://www.gnu.org/copyleft/gpl.html
//
// --------------------------------------------------------------------
//
// This is a Greasemonkey user script.
//
// To install, you need Greasemonkey: http://greasemonkey.mozdev.org/
// Then restart Firefox and revisit this script.
// Under Tools, there will be a new menu item to "Install User Script".
// Accept the default configuration and install.
//
// To uninstall, go to Tools/Manage User Scripts,
// select "Hello World", and click Uninstall.
//
// --------------------------------------------------------------------
//
// ==UserScript==
// @name          Hello World
// @namespace     http://diveintogreasemonkey.org/download/
// @description   example script to alert "Hello world!" on every page
// @include       *
// @exclude       http://diveintogreasemonkey.org/*
// @exclude       http://www.diveintogreasemonkey.org/*
// ==/UserScript==

alert('Hello world!');]]></programlisting>
</example>
<para>As you can see, most of the lines in the <filename>Hello World</filename> user script are comments.  Some of these comments, like the instructions on how to install it, have no special meaning; they are simply there for the benefit of clueless end users.  However, there is a section in the comments that <emphasis>does</emphasis> have special meaning, as you'll see in the next section.</para>
<para>To see the user script in action, you should <link linkend="basic.installscript">install it in the usual way</link>, then visit a page outside the <systemitem class="domainname">diveintogreasemonkey.org</systemitem> domain (for example, <ulink url="&url_google;">Google</ulink>).  The page should display as normal, but an alert will pop up saying <guilabel>Hello world!</guilabel></para>
<itemizedlist role="download">
<title>Download</title>
<listitem><para><ulink url="&url_example_helloworld;"><filename>helloworld.user.js</filename></ulink></para></listitem>
</itemizedlist>
</section> <!-- first.divein -->

<section id="first.metadata">
<?dbhtml filename="helloworld/metadata.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Every user script has a section of metadata that tells Greasemonkey about the script itself, where it came from, and when to run it.</para>
</abstract>
</sectioninfo>
<title>Describing your user script with metadata</title>
<example id="example.helloworld.metadata">
<title>Hello World metadata</title>
<programlisting><![CDATA[// ==UserScript==
// @name          Hello World
// @namespace     http://diveintogreasemonkey.org/download/
// @description   example script to alert "Hello world!" on every page
// @include       *
// @exclude       http://diveintogreasemonkey.org/*
// @exclude       http://www.diveintogreasemonkey.org/*
// ==/UserScript==]]></programlisting>
</example>
<para>There are six separate pieces of metadata here, wrapped in a set of Greasemonkey-specific comments.  Let's take them in order, starting with the wrapper.</para>
<informalexample>
<programlisting><![CDATA[// ==UserScript==
//
// ==/UserScript==]]></programlisting>
<para>These comments are significant, and must match exactly.  Greasemonkey uses them to signal the start and end of your user script metadata.  This section may be defined anywhere in your script, but is usually near the top.</para>
</informalexample>
<para>Within the Greasemonkey metadata section, the first item is the name.</para>
<informalexample>
<programlisting><![CDATA[// @name          Hello World]]></programlisting>
<para>This is the name of your user script.  It is displayed in the install dialog when you first install the script, and later in the <interface role="windowtitle">Manage User Scripts</interface> dialog.  It should be short and to the point.</para>
<para><literal>@name</literal> is optional.  If present, it may appear only once.  If not present, it defaults to the filename of the user script, minus the <filename>.user.js</filename> extension.</para>
</informalexample>
<para>Next comes the namespace.</para>
<informalexample>
<programlisting><![CDATA[// @namespace     http://diveintogreasemonkey.org/download/]]></programlisting>
<para>This is a &url;, and Greasemonkey uses it to distinguish user scripts that have the same name but are written by different authors.  If you have a domain name, you can use it (or a subdirectory) as your namespace.  Otherwise you can use a <ulink url="&url_taguri;"><systemitem>tag:</systemitem> &uri;</ulink>.</para>
<para><literal>@namespace</literal> is optional.  If present, it may appear only once.  If not present, it defaults to the domain from which the user downloaded the user script.</para>
</informalexample>
<tip>
<title/>
<para>You can specify the items of your user script metadata in any order.  I like <literal>@name</literal>, <literal>@namespace</literal>, <literal>@description</literal>, <literal>@include</literal>, and finally <literal>@exclude</literal>, but there is nothing special about this order.</para>
</tip>
<para>Next comes the description.</para>
<informalexample>
<programlisting><![CDATA[// @description   example script to alert "Hello world!" on every page]]></programlisting>
<para>This is a human-readable description of what the user script does.  It is displayed in the install dialog when you first install the script, and later in the <interface role="windowtitle">Manage User Scripts</interface> dialog.  It should be no more than two sentences.</para>
<para><literal>@description</literal> is optional.  If present, it may appear only once.  If not present, it defaults to an empty string.</para>
</informalexample>
<important>
<title/>
<para>Don't forget the <literal>@description</literal>.  Even if you are only writing user scripts for yourself, you will eventually end up with dozens of them, and administering them all in the <interface role="windowtitle">Manage User Scripts</interface> dialog will be much more difficult if you don't include a description.</para>
</important>
<para>The next three lines are the most important items (from Greasemonkey's perspective): the <literal>@include</literal> and <literal>@exclude</literal> &url;s.</para>
<informalexample>
<programlisting><![CDATA[// @include       *
// @exclude       http://diveintogreasemonkey.org/*
// @exclude       http://www.diveintogreasemonkey.org/*]]></programlisting>
<para>These lines tell Greasemonkey on which sites you want your user script to execute.  Both specify a &url;, with the <literal>*</literal> character as a simple wildcard for part of the domain name or path.  In this case, we are telling Greasemonkey to execute the Hello World script on all sites except <systemitem class="domainname">http://diveintogreasemonkey.org/</systemitem> and <systemitem class="domainname">http://www.diveintogreasemonkey.org/</systemitem>.  Excludes take precedence over includes, so even though <systemitem class="domainname">http://diveintogreasemonkey.org/download/</systemitem> matches <literal>*</literal> (all sites), it will be excluded because it also matches <systemitem class="domainname">http://diveintogreasemonkey.org/*</systemitem>.</para>
<para><literal>@include</literal> and <literal>@exclude</literal> are optional.  You may specify as many included and excluded &url;s as you need, but you must specify each on its own line.  If neither is specified, Greasemonkey will execute your user script on all sites (as if you had specified <literal>@include *</literal>).</para>
</informalexample>
<note>
<title/>
<para>You need to be very specific with your <literal>@include</literal> and <literal>@exclude</literal> metadata.  Greasemonkey makes no assumptions about &url;s that an end user might consider equivalent.  If a site responds on both <systemitem class="domainname">http://example.com/</systemitem> and <systemitem>http://www.example.com/</systemitem>, you need to declare both variations.</para>
</note>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_taguri;"><systemitem>tag:</systemitem> &uri;s</ulink></para></listitem>
</itemizedlist>
</section> <!-- first.metadata -->

<section id="first.helloworld">
<?dbhtml filename="helloworld/code.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Our first user script simply displays an alert saying <guilabel>Hello world!</guilabel> when it is executed.</para>
</abstract>
</sectioninfo>
<title>Coding your user script</title>
<example id="example.helloworld.alert">
<title>Display the <guilabel>Hello world!</guilabel> alert</title>
<programlisting><![CDATA[alert('Hello world!');]]></programlisting>
</example>
<para>Although this code looks obvious enough, and does exactly what you would expect, Greasemonkey is actually doing a number of things behind the scenes to ensure that user scripts do not interact badly with other scripts defined by the original page.  Specifically, it automatically wraps your user script in an anonymous function wrapper.  Ordinarily you can ignore this, but it will eventually creep up and bite you in the ass, so you may as well learn about it now.</para>
<para>One of the most common ways this can bite you is that variables and functions that you define in a user script are <emphasis>not</emphasis> available to other scripts.  In fact, they are not available at all once the user script has finished running.  This means that you will run into problems if you are expecting to be able to call your own functions later by using the <methodname>window.setTimeout</methodname> function, or by setting string-based &onclick; attributes on links and expecting Javascript to evaluate your function names later.</para>
<para>For example, this user script defines a function <function>helloworld</function>, then attempts to set a timer to call it one second later.</para>
<example id="example.settimeout.bad">
<title>Bad way to delay calling a function</title>
<programlisting><![CDATA[function helloworld() {
    alert('Hello world!');
}

window.setTimeout("helloworld()", 60);]]></programlisting>
<para>This will not work; no alert will be displayed.  If you open <link linkend="debug.console">JavaScript Console</link>, you will see an exception displayed: <computeroutput>Error: helloworld is not defined.</computeroutput>  This is because, by the time the timeout expires and the call to <literal>helloworld()</literal> is evaluated, the <function>helloworld</function> function no longer exists.</para>
</example>
<para>If you need to reference your user script's variables or functions later, you will need to explicitly define them as properties of the <varname>window</varname> object, which is always available.</para>
<example id="example.settimeout.better">
<title>Better way to delay calling a function</title>
<programlisting><![CDATA[window.helloworld = function() {
    alert('Hello world!');
}

window.setTimeout("helloworld()", 60);]]></programlisting>
<para>This works as expected: one second after the page loads, an alert pops up proudly displaying <guilabel>Hello world!</guilabel></para>
</example>
<para>However, setting properties on <varname>window</varname> is still not ideal; it's a bit like using a global variable when a local one will do.  (Actually, it's exactly like that, since <varname>window</varname> is global and available to all scripts on the page.)  More practically, you could end up interfering with other scripts that were defined on the page, or even other user scripts.</para>
<para>The best solution is to define an anonymous function yourself and pass it as the first argument to <function>window.setTimeout</function>.</para>
<example id="example.settimeout.best">
<title>Best way to delay calling a function</title>
<programlisting><![CDATA[window.setTimeout(function() { alert('Hello world!') }, 60);]]></programlisting>
<para>What I'm doing here is creating a function without a name (an <quote>anonymous function</quote>), then immediately passing the function itself to <function>window.setTimeout</function>.  This accomplishes the same thing as the previous example, but it leaves no trace, i.e. it's undetectable to other scripts.</para>
<para>I find that I use anonymous functions regularly while writing user scripts.  They are ideal for creating <quote>one-off</quote> functions and passing them as arguments to things like <function>window.setTimeout</function>, <function>document.addEventListener</function>, or assigning to event handlers like &click; or &submit;.</para>
</example>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_jsanonymousfunctions;">Anonymous functions in Javascript</ulink></para></listitem>
<listitem><para><ulink url="&url_jsblockscope;">Block Scope in Javascript</ulink> and <ulink url="&url_jsblockscope_comments;">associated discussion thread</ulink></para></listitem>
</itemizedlist>
</section>

<section id="first.editing">
<?dbhtml filename="helloworld/editing.html"?>
<sectioninfo>
<abstract>
<title/>
<para>For script authors, the <interface role="windowtitle">Manage User Scripts</interface> dialog has a feature that is especially useful: an <guibutton>Edit</guibutton> button to edit an installed script <quote>live</quote>.</para>
</abstract>
</sectioninfo>
<title>Editing your user script</title>
<procedure id="procedure.live.edit">
<title>Edit Hello World source code and see the results</title>
<mediaobject>
<videoobject><videodata fileref="&url_videos;live-editing.swf" format="SWF"/></videoobject>
<textobject><phrase>Watch the video: <ulink url="&url_videos;live-editing.html">live editing</ulink>.</phrase></textobject>
</mediaobject>
<step><para>From the menu, select <menuchoice><guimenu><accel>T</accel>ools</guimenu><guimenuitem>Manage <accel>U</accel>ser Scripts...</guimenuitem></menuchoice>.  Greasemonkey will pop up the <interface role="windowtitle">Manage User Scripts</interface> dialog.</para></step>
<step><para>In the left-hand pane, select Hello World and click <guibutton>Edit</guibutton>.  This should open the installed version of Hello World in your favorite text editor.  (If it doesn't, verify that <filename>.js</filename> files are associated with your favorite text editor.)</para></step>
<step><para>Change the <function>alert</function> statement to display <guilabel>Live editing!</guilabel> instead.</para></step>
<step><para>Save your changes in your editor, then go back to your browser and test the change by refreshing any page.  You should see the results of your change immediately; there is no need to re-install or <quote>refresh</quote> your user script in any way.  You are editing <quote>live</quote>.</para></step>
</procedure>
<tip>
<title/>
<para>When you click <guibutton>Edit</guibutton> in the <interface role="windowtitle">Manage User Scripts</interface> dialog, you are <quote>live</quote> editing a copy of your script that is buried deep inside your Firefox profile directory.  I've gotten into the habit, once I've finished a <quote>live</quote> editing session, of going back to my text editor one last time and selecting <menuchoice><guimenu><accel>F</accel>ile</guimenu><guimenuitem>Save <accel>a</accel>s...</guimenuitem></menuchoice>, and saving the user script in another directory.  While it's not necessary (Greasemonkey only pays attention to the copy in your profile directory), I prefer to keep the <quote>master copy</quote> of my scripts in another directory with the rest of my work.</para>
</tip>
</section> <!-- first.editing -->
</chapter> <!-- first -->

<chapter id="debug">
<?dbhtml filename="debug/index.html"?>
<title>Debugging User Scripts</title>

<section id="debug.console">
<?dbhtml filename="debug/javascript-console.html"?>
<sectioninfo>
<abstract>
<title/>
<para>If your user script doesn't appear to be running, the first place to check is JavaScript Console, which lists all script-related errors, including user scripts.</para>
</abstract>
</sectioninfo>
<title>Tracking crashes with JavaScript Console</title>
<procedure id="procedure.debug.javascriptconsole">
<title>Open JavaScript Console</title>
<mediaobject>
<videoobject><videodata fileref="&url_videos;javascript-console.swf" format="SWF"/></videoobject>
<textobject><phrase>Watch the video: <ulink url="&url_videos;javascript-console.html">JavaScript Console demonstration</ulink>.</phrase></textobject>
</mediaobject>
<step><para>From the Firefox menu, select <menuchoice><guimenu><accel>T</accel>ools</guimenu><guimenuitem>Javascript <accel>C</accel>onsole</guimenuitem></menuchoice>.</para></step>
<step><para>The console lists all script errors on all pages since you opened Firefox, which can be quite a lot.  (You'd be surprised how many high-profile sites have scripts that crash regularly.)  Click <guibutton><accel>C</accel>lear</guibutton> to clear the list before starting to debug your own user script.</para></step>
</procedure>
<para>Now refresh the page you were working on to test the user script that doesn't appear to be doing anything.  If it is indeed crashing, an exception will be displayed in JavaScript Console.</para>
<note>
<title/>
<para>If your user script is crashing, JavaScript Console will display an exception and a line number.  Due to the way Greasemonkey injects user scripts into a page, this line number is not actually useful, and you should ignore it.  It is <emphasis>not</emphasis> the line number within your user script where the exception occurred.</para>
</note>
</section> <!-- first.console -->

<section id="debug.gmlog">
<?dbhtml filename="debug/gm_log.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Greasemonkey provides a logging function, <function>GM_log</function>, that allows you to write messages to JavaScript Console.  Such messages should be taken out before release, but they are enormously helpful in debugging.  Plus, watching the console pile up with log messages is much more satisfying than sprinkling alerts throughout your code and clicking <guibutton>OK</guibutton> over and over.</para>
</abstract>
</sectioninfo>
<title>Logging with <function>GM_log</function></title>
<para><function>GM_log</function> takes one argument, the string to be logged.  After logging to JavaScript Console, the user script will continue executing normally.</para>
<example id="example.gmlog">
<title>Write to JavaScript Console and continue (<ulink url="&url_example_gmlog;"><filename>gmlog.user.js</filename></ulink>)</title>
<programlisting><![CDATA[
if (/^http:\/\/diveintogreasemonkey\.org\//.test(window.location.href)) {
    GM_log('running on Dive Into Greasemonkey site w/o www prefix');
} else {
    GM_log('running elsewhere');
}
GM_log('this line is always printed');
]]></programlisting>
</example>
<para>If you install this user script and open <ulink url="&url_book;"/>, these two lines will appear in JavaScript Console:</para>
<informalexample>
<screen><computeroutput>Greasemonkey: http://diveintomark.org/projects/greasemonkey//Test Log:
running on Dive Into Greasemonkey site w/o www prefix</computeroutput>
<computeroutput>Greasemonkey: http://diveintomark.org/projects/greasemonkey//Test Log:
this line is always printed</computeroutput></screen>
</informalexample>
<para>As you can see, Greasemonkey includes the namespace and script name, taken from the <link linkend="first.metadata">user script's metadata section</link>, then the message that was passed as an argument to <function>GM_log</function>.</para>
<para>If you visit somewhere other than <ulink url="&url_book;"/>, these two lines will appear in JavaScript Console:</para>
<informalexample>
<screen><computeroutput>Greasemonkey: http://diveintomark.org/projects/greasemonkey//Test Log:
running elsewhere</computeroutput>
<computeroutput>Greasemonkey: http://diveintomark.org/projects/greasemonkey//Test Log:
this line is always printed</computeroutput></screen>
</informalexample>
<para>I tried and failed to find a length limit for logged messages.  It is larger than 255 characters.  Plus, lines in JavaScript Console wrap properly, so you can always scroll down to see the rest of your log message.  Go nuts with logging!</para>
<tip>
<title/>
<para>In JavaScript Console, you can right-click (Mac users control-click) on any line and select <menuchoice><guimenuitem><accel>C</accel>opy</guimenuitem></menuchoice> to copy it to the clipboard.</para>
</tip>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="api.gmlog"/></para></listitem>
</itemizedlist>
</section> <!-- debug.gmlog -->

<section id="debug.domi">
<?dbhtml filename="debug/dom-inspector.html"?>
<sectioninfo>
<abstract>
<title/>
<para>DOM Inspector allows you to explore the parsed document object model (DOM) of any page.  You can get details on each &html; element, attribute, and text node.  You can see all the CSS rules from each of the page's stylesheets.  You can explore all the scriptable properties of an object.  It's extremely powerful.</para>
</abstract>
</sectioninfo>
<title>Inspecting elements with DOM Inspector</title>
<para>DOM Inspector is included with the Firefox installation program, but depending on your platform, it may not installed by default.  If you don't see <guimenuitem>DOM I<accel>n</accel>spector</guimenuitem> in the <guimenu><accel>T</accel>ools</guimenu> menu, you will need to re-install Firefox to get DOM Inspector.  This will not affect your existing bookmarks, preferences, extensions, or user scripts.</para>
<procedure id="procedure.debug.install.domi">
<title>Install DOM Inspector</title>
<step><para>Run the Firefox installation program.</para></step>
<step><para>After accepting the licensing agreement, select <guibutton><accel>C</accel>ustom</guibutton> install.</para></step>
<step><para>After selecting the destination directory, the installation wizard will ask you to choose additional components you want to install.  Select <guibutton>Developer Tools</guibutton>.</para></step>
<step><para>After the installation is finished, run Firefox.  You should see a new menu item, <menuchoice><guimenu><accel>T</accel>ools</guimenu><guimenuitem>DOM I<accel>n</accel>spector</guimenuitem></menuchoice>.</para></step>
</procedure>
<para>To get a sense of how powerful this tool really is, let's take a tour of the DOM of &title;'s home page.</para>
<procedure id="procedure.debug.domi">
<title>Inspect and edit the &title; home page</title>
<mediaobject>
<videoobject><videodata fileref="&url_videos;dom-inspector.swf" format="SWF"/></videoobject>
<textobject><phrase>Watch the video: <ulink url="&url_videos;dom-inspector.html">DOM Inspector demonstration</ulink>.</phrase></textobject>
</mediaobject>
<step><para>Visit <ulink url="&url_book;"/>.</para></step>
<step><para>From the menu, select <menuchoice><guimenu><accel>T</accel>ools</guimenu><guimenuitem>DOM I<accel>n</accel>spector</guimenuitem></menuchoice> to open DOM Inspector.</para></step>
<step><para>In the DOM Inspector window, you should see a list of DOM nodes in the left-hand pane.  If you don't, open the dropdown menu in the upper-left corner and select <menuchoice><guimenuitem>DOM Nodes</guimenuitem></menuchoice>.</para></step>
<step><para>The DOM node tree always starts with the document element, labeled <literal>#document</literal>.  Expand this to reveal the <sgmltag>HTML</sgmltag> element.</para></step>
<step><para>Expand the <sgmltag>HTML</sgmltag> element to reveal 3 nodes: <sgmltag>HEAD</sgmltag>, <literal>#text</literal>, and <sgmltag>BODY</sgmltag>.  Note that <sgmltag>BODY</sgmltag> has an <sgmltag class="attribute">id</sgmltag> of <literal>diveintogreasemonkey-org</literal>.  Adjust the column widths if you don't see this.</para></step>
<step><para>Expand <sgmltag>BODY</sgmltag> to reveal 5 nodes: <literal>#text</literal>, <sgmltag>DIV id="intro"</sgmltag>, <literal>#text</literal>, <sgmltag>DIV id="main"</sgmltag>, and <literal>#text</literal>.</para></step>
<step><para>Expand <sgmltag>DIV id="intro"</sgmltag> to reveal 2 nodes: <literal>#text</literal> and <sgmltag>DIV class="sectionInner"</sgmltag>.</para></step>
<step><para>Expand <sgmltag>DIV class="sectionInner"</sgmltag> to reveal 2 nodes: <literal>#text</literal> and <sgmltag>DIV class="sectionInner2"</sgmltag>.</para></step>
<step><para>Expand <sgmltag>DIV class="sectionInner2"</sgmltag> to reveal 5 nodes: <literal>#text</literal>, <sgmltag>DIV class="s"</sgmltag>, <literal>#text</literal>, <sgmltag>DIV class="s"</sgmltag>, and <literal>#text</literal>.</para></step>
<step><para>Expand the first <sgmltag>DIV class="s"</sgmltag> to reveal 5 nodes: <literal>#text</literal>, <sgmltag>H1</sgmltag>, <literal>#text</literal>, <sgmltag>P</sgmltag>, and <literal>#text</literal>.</para></step>
<step><para>Select the <sgmltag>H1</sgmltag> node.  On the original page (behind DOM Inspector), the <sgmltag>H1</sgmltag> element should briefly flash a red border.  In the right-hand pane, you should see the node name (<guilabel>H1</guilabel>), namespace &uri; (blank, since &html; does not have a namespace -- this is only used on pages served as <systemitem>application/xhtml+xml</systemitem>, or pages displaying &xml; in some other namespace), node type (<literal>1</literal> is an element), and node value (blank, since headers do not have a value -- the text within the header has its own node).</para></step>
<step><para>In the dropdown menu at the top of the right-hand pane, you will see a number of choices: <guimenuitem>DOM Node</guimenuitem>, <guimenuitem>Box Model</guimenuitem>, <guimenuitem>XBL Bindings</guimenuitem>, <guimenuitem>CSS Style Rules</guimenuitem>, <guimenuitem>Computed Style</guimenuitem>, and <guimenuitem>Javascript Object</guimenuitem>.  These provide different information about the currently selected node.  Some of them are editable, and changes are immediately reflected on the original page.  Select <guimenuitem>Javascript Object</guimenuitem> to see all the scriptable properties and methods of the selected <sgmltag>H1</sgmltag> element.</para></step>
<step><para>Select <guimenuitem>CSS Style Rules</guimenuitem>.  The right-hand pane will split into two panes, the top showing a list of all rules that affect the element (including default rules built into the browser itself), the bottom showing individual properties defined by those rules.</para></step>
<step><para>Select the second rule from the top-right pane, the style rules defined by the stylesheet at <ulink url="&url_stylesheet;"/>.</para></step>
<step><para>Double-click the <property>font-variant</property> property from the bottom-right pane and enter a new value of <userinput>normal</userinput>.  In the original page (behind DOM Inspector), the <quote>Dive Into Greasemonkey</quote> logo text should immediately change from small-caps to normal uppercase and lowercase letters.</para></step>
<step><para>Right-click (Mac users control-click) anywhere in the bottom-right pane and select <guimenuitem>New Property</guimenuitem>.  A dialog will pop up titled <interface role="windowtitle">New Style Rule</interface>.  Enter a property name of <userinput>background-color</userinput> and click <guibutton>OK</guibutton>, then a property value of <userinput>red</userinput> and click <guibutton>OK</guibutton> to apply the new property.  The new property and value should show up in the bottom-right pane along with the existing properties, and the logo text in the original page should immediately change to a red background.</para></step>
</procedure>
<para>If clicking through each level of the DOM node tree is not your idea of a good time, I highly recommend the Inspect Element extension, which allows you to drill directly to a specific element in DOM Inspector.</para>
<warning>
<title/>
<para>You <emphasis>must</emphasis> install DOM Inspector before installing the Inspect Element extension, otherwise Firefox will crash on startup.  If this has already happened to you, open a command line window, navigate to the directory where you installed Firefox, and type <userinput>firefox -safe-mode</userinput>.  Firefox will start up without loading extensions, then select <menuchoice><guimenu><accel>T</accel>ools</guimenu><guimenuitem><accel>E</accel>xtensions</guimenuitem></menuchoice> and uninstall Inspect Element.</para>
</warning>
<procedure id="procedure.debug.inspectelement">
<title>Directly inspect an element with Inspect Element</title>
<mediaobject>
<videoobject><videodata fileref="&url_videos;inspect-element.swf" format="SWF"/></videoobject>
<textobject><phrase>Watch the video: <ulink url="&url_videos;inspect-element.html">Inspect Element demonstration</ulink>.</phrase></textobject>
</mediaobject>
<step><para>Visit the <ulink url="&url_inspectelementextension;">Inspect Element</ulink> download page and click <guibutton>Install Now</guibutton>.</para></step>
<step><para>Restart Firefox.</para></step>
<step><para>Revisit <ulink url="&url_book;"/>.</para></step>
<step><para>Right-click (Mac users control-click) on the logo text, <literal>Dive Into Greasemonkey</literal>.</para></step>
<step><para>From the context menu, select <guimenuitem>Inspect element</guimenuitem>.  DOM Inspector should open with the <sgmltag>H1</sgmltag> element already selected, and you can immediately start inspecting and/or editing its properties.</para></step>
</procedure>
<warning>
<title/>
<para>DOM Inspector does not <quote>follow</quote> you as you browse.  If you open DOM Inspector and then navigate somewhere else in the original window, DOM Inspector will get very confused.  It's best to go where you want to go, inspect what you want to inspect, then close DOM Inspector before doing anything else.</para>
</warning>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_domi_intro;">Introduction to the DOM Inspector</ulink></para></listitem>
<listitem><para><ulink url="&url_inspectelementextension;">Inspect Element extension</ulink></para></listitem>
<listitem><para><ulink url="&url_inspectorwidget;">Inspector Widget extension</ulink>, an alternative to the Inspect Element extension that adds a toolbar button instead of a context menu item.</para></listitem>
</itemizedlist>
</section> <!-- debug.domi -->

<section id="debug.shell">
<?dbhtml filename="debug/javascript-shell.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Javascript Shell is a bookmarklet that allows you to evaluate arbitrary Javascript expressions in the context of the current page.</para>
</abstract>
</sectioninfo>
<title>Evaluating expressions with Javascript Shell</title>
<procedure id="procedure.debug.javascriptshell">
<title>Install Javascript Shell</title>
<step><para>Visit <ulink url="&url_jessebookmarklets;">Jesse's Web Development Bookmarklets</ulink>.</para></step>
<step><para>Drag the <guibutton>Shell</guibutton> bookmarklet to your links toolbar.</para></step>
<step><para>Visit a page (for example, <ulink url="&url_book;">&title;</ulink> home page), and click the <guibutton>Shell</guibutton> bookmarklet in your links toolbar.  The Javascript Shell window will open in the background.</para></step>
</procedure>
<para>Javascript Shell offers you the same power as <link linkend="debug.domi">DOM Inspector</link>, but in a free-form environment.  Think of it as a command line for the DOM.  Let's play.</para>
<example id="example.debug.javascriptshell">
<title>Introduction to Javascript Shell</title>
<screen><userinput>document.title</userinput>
<computeroutput>Dive Into Greasemonkey</computeroutput>
<userinput>document.title = 'Hello World'</userinput>
<computeroutput>Hello World</computeroutput>
<userinput>var paragraphs = document.getElementsByTagName('p')</userinput>
<userinput>paragraphs</userinput>
<computeroutput>[object HTMLCollection]</computeroutput>
<userinput>paragraphs.length</userinput>
<computeroutput>5</computeroutput>
<userinput>paragraphs[0]</userinput>
<computeroutput>[object HTMLParagraphElement]</computeroutput>
<userinput>paragraphs[0].innerHTML</userinput>
<computeroutput>Teaching an old web new tricks</computeroutput>
<userinput>paragraphs[0].innerHTML = 'Live editing, baby!'</userinput>
<computeroutput>Live editing, baby!</computeroutput></screen>
<para>Your changes should be reflected in the original page as soon as you hit <keycap>ENTER</keycap>.</para>
</example>
<para>The only other thing I want to mention about Javascript Shell is the <function>props</function> function.</para>
<example id="example.debug.props">
<title>Get properties of an element</title>
<screen><userinput>var link = document.getElementsByTagName('a')[0]</userinput>
<userinput>props(link)</userinput>
<computeroutput role="props">Methods of prototype: blur, focus
Fields of prototype: id, title, lang, dir, className, accessKey,
charset, coords, href, hreflang, name, rel, rev, shape, tabIndex,
target, type, protocol, host, hostname, pathname, search, port,
hash, text, offsetTop, offsetLeft, offsetWidth, offsetHeight,
offsetParent, innerHTML, scrollTop, scrollLeft, scrollHeight,
scrollWidth, clientHeight, clientWidth, style
Methods of prototype of prototype of prototype: insertBefore,
replaceChild, removeChild, appendChild, hasChildNodes, cloneNode,
normalize, isSupported, hasAttributes, getAttribute, setAttribute,
removeAttribute, getAttributeNode, setAttributeNode,
removeAttributeNode, getElementsByTagName, getAttributeNS,
setAttributeNS, removeAttributeNS, getAttributeNodeNS,
setAttributeNodeNS, getElementsByTagNameNS, hasAttribute,
hasAttributeNS, addEventListener, removeEventListener, dispatchEvent,
compareDocumentPosition, isSameNode, lookupPrefix, isDefaultNamespace,
lookupNamespaceURI, isEqualNode, getFeature, setUserData, getUserData
Fields of prototype of prototype of prototype: tagName, nodeName,
nodeValue, nodeType, parentNode, childNodes, firstChild, lastChild,
previousSibling, nextSibling, attributes, ownerDocument, namespaceURI,
prefix, localName, ELEMENT_NODE, ATTRIBUTE_NODE, TEXT_NODE,
CDATA_SECTION_NODE, ENTITY_REFERENCE_NODE, ENTITY_NODE,
PROCESSING_INSTRUCTION_NODE, COMMENT_NODE, DOCUMENT_NODE,
DOCUMENT_TYPE_NODE, DOCUMENT_FRAGMENT_NODE, NOTATION_NODE,
baseURI, textContent, DOCUMENT_POSITION_DISCONNECTED,
DOCUMENT_POSITION_PRECEDING, DOCUMENT_POSITION_FOLLOWING,
DOCUMENT_POSITION_CONTAINS, DOCUMENT_POSITION_CONTAINED_BY,
DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC
Methods of prototype of prototype of prototype of prototype of prototype: toString</computeroutput></screen>
<para>To coin a phrase, <quote>Whoa!</quote>  What's all that about?  It's a list of all the properties and methods of that <sgmltag>&lt;a&gt;</sgmltag> element that are available to you in Javascript, grouped by levels in the DOM object hierarchy.  Methods and properties that are specific to link elements (like the <methodname>blur</methodname> and <methodname>focus</methodname> methods, and the <property>href</property> and <property>hreflang</property> properties) are listed first, followed by methods and properties shared by all types of nodes (like the <methodname>insertBefore</methodname> method), and so on.</para>
<para>Again, this is the same information that is available in DOM Inspector... but with more typing and experimenting, and less pointing and clicking.</para>
</example>
<warning>
<title/>
<para>Like <link linkend="debug.domi">DOM Inspector</link>, Javascript Shell does not <quote>follow</quote> you as you browse.  If you open Javascript Shell and then navigate somewhere else in the original window, Javascript Shell will get very confused.  It's best to go where you want to go, open Javascript Shell, fiddle to your heart's content, then close Javascript Shell before doing anything else.</para>
</warning>
</section>

<section id="debug.other">
<?dbhtml filename="debug/other.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Here is a list of other debugging tools that I have found useful, but haven't had time to document fully.</para>
</abstract>
</sectioninfo>
<title>Other debugging tools</title>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_webdeveloperextension;">Web Developer Extension</ulink> contains a plethora of functions for deconstructing pages.</para></listitem>
<listitem><para><ulink url="&url_aardvarkextension;">Aardvark</ulink> interactively displays tag names, <sgmltag class="attribute">id</sgmltag> and <sgmltag class="attribute">class</sgmltag> attributes.</para></listitem>
<listitem><para><ulink url="&url_venkmandebugger;">Venkman Javascript Debugger</ulink> is a complete run-time Javascript debugger.</para></listitem>
<listitem><para><ulink url="&url_jessebookmarklets;">Web Development Bookmarklets</ulink> contains a number of useful functions you can drag to your toolbar.</para></listitem>
<listitem><para><ulink url="&url_jsunit;">JSUnit</ulink> is a unit testing framework for Javascript.</para></listitem>
<listitem><para><ulink url="&url_jslint;">js-lint</ulink> checks Javascript code for common errors.</para></listitem>
</itemizedlist>
</section> <!-- debug.other -->

</chapter> <!-- debug -->

<chapter id="pattern">
<?dbhtml filename="patterns/index.html"?>
<title>Common Patterns</title>

<section id="pattern.matchdomain">
<?dbhtml filename="patterns/domain.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Many sites work equally well whether you include the <systemitem>www.</systemitem> prefix in the address or not.  If you want to write a user script for such sites, you need to make sure to catch both versions of the address.</para>
</abstract>
</sectioninfo>
<title>Executing a user script on a domain and all its subdomains</title>
<example id="example.pattern.matchdomain">
<title>Metadata tags to match a domain and all subdomains</title>
<programlisting><![CDATA[// ==UserScript==
// @include http://example.com/*
// @include http://*.example.com/*
// ==/UserScript==]]></programlisting>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
<listitem><para><ulink url="&url_example_salonautopass;">Salon Auto-Pass</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.matchdomain -->

<section id="pattern.test">
<?dbhtml filename="patterns/function-exists.html"?>
<sectioninfo>
<abstract>
<title/>
<para>New versions of Greasemonkey expose new functions to user scripts.  If you plan to distribute your user scripts, you should check that the Greasemonkey functions you use actually exist.</para>
</abstract>
</sectioninfo>
<title>Testing whether a Greasemonkey function is available</title>
<example id="example.pattern.test">
<title>Alert the user if the <function>GM_xmlhttpRequest</function> function is not available</title>
<programlisting><![CDATA[if (!GM_xmlhttpRequest) {
    alert('Please upgrade to the latest version of Greasemonkey.');
    return;
}
// more code here that uses GM_xmlhttpRequest]]></programlisting>
</example>
</section> <!-- pattern.test -->

<section id="pattern.testelement">
<?dbhtml filename="patterns/element-exists.html"?>
<sectioninfo>
<abstract>
<title/>
<para>You can use the <function>getElementsByTagName</function> function to test whether an &html; element exists on a page.</para>
</abstract>
</sectioninfo>
<title>Testing whether a page includes an &html; element</title>
<example id="example.pattern.testelement">
<title>Check if the page contains a <sgmltag>&lt;textarea&gt;</sgmltag></title>
<programlisting><![CDATA[var textareas = document.getElementsByTagName('textarea');
if (textareas.length) {
    // there is at least one textarea on this page
} else {
    // there are no textareas on this page
}]]></programlisting>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_betterdir;">BetterDir</ulink></para></listitem>
<listitem><para><ulink url="&url_example_zoomtextarea;">Zoom Textarea</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.testelement -->

<section id="pattern.everyelement">
<?dbhtml filename="patterns/iterate-every-element.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Sometimes you need to do something with every &html; element on a page.  Firefox supports <function>getElementsByTagName('*')</function>, which returns a collection you can loop through.</para>
</abstract>
</sectioninfo>
<title>Doing something for every &html; element</title>
<example id="example.pattern.everyelement">
<title>Loop through every element</title>
<programlisting><![CDATA[var allElements, thisElement;
allElements = document.getElementsByTagName('*');
for (var i = 0; i < allElements.length; i++) {
    thisElement = allElements[i];
    // do something with thisElement
}]]></programlisting>
</example>
<note>
<title/>
<para>You should only do this if you really need to do something with <emphasis>every</emphasis> element.  If you know in advance that you only want to operate on certain elements, it will be faster to use an XPath query to get exactly the elements you want.  See <xref linkend="pattern.certainattribute"/> for more information.</para>
</note>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_antidisabler;">Anti-Disabler</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.everyelement -->

<section id="pattern.oneelement">
<?dbhtml filename="patterns/iterate-one-element.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Sometimes you need to do something with every instance of a particular &html; element on a page.  For example, you could change the font on every <sgmltag>&lt;textarea&gt;</sgmltag>.  The easiest way to do this is to call <function>getElementsByTagName('tagname')</function>, which returns a collection you can loop through.</para>
</abstract>
</sectioninfo>
<title>Doing something for every instance of a specific &html; element</title>
<example id="example.pattern.oneelement">
<title>Find all the textareas on a page</title>
<programlisting><![CDATA[var allTextareas, thisTextarea;
allTextareas = document.getElementsByTagName('textarea');
for (var i = 0; i < allTextareas.length; i++) {
    thisTextarea = allTextareas[i];
    // do something with thisTextarea
}]]></programlisting>
</example>
<note>
<title/>
<para>You should not use this pattern to do something to every link on the page, because the <sgmltag>&lt;a&gt;</sgmltag> element can also be used for in-page anchors.  See <xref linkend="pattern.certainattribute"/> for how to find all the links on a page.</para>
</note>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_zoomtextarea;">Zoom Textarea</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.oneelement -->

<section id="pattern.certainattribute">
<?dbhtml filename="patterns/match-attribute.html"?>
<sectioninfo>
<abstract>
<title/>
<para>The single most powerful tool in your Greasemonkey arsenal is the <function>evaluate</function> method, which finds elements, attributes, and text on a page using a query language called XPath.</para>
</abstract>
</sectioninfo>
<title>Doing something for every element with a certain attribute</title>
<para>Let's say, for example, that you wanted to find all the links on a page.  You might consider using <function>document.getElementsByTagName('a')</function>, but then you'll still need to check each element to see if it has an <sgmltag class="attribute">href</sgmltag> attribute, because the <sgmltag>&lt;a&gt;</sgmltag> element can also be used for named anchors.</para>
<para>Instead, use Firefox's built-in XPath support to find all the <sgmltag>&lt;a&gt;</sgmltag> elements that have an <sgmltag class="attribute">href</sgmltag> attribute.</para>
<example id="example.pattern.certainattribute.a.href">
<title>Find all the links on a page</title>
<programlisting><![CDATA[var allLinks, thisLink;
allLinks = document.evaluate(
    '//a[@href]',
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);
for (var i = 0; i < allLinks.snapshotLength; i++) {
    thisLink = allLinks.snapshotItem(i);
    // do something with thisLink
}]]></programlisting>
<para>The <methodname>document.evaluate</methodname> method is the key here.  It takes an XPath query as a string, then a bunch of other parameters I'll explain in a minute.  This XPath query finds all the <sgmltag>&lt;a&gt;</sgmltag> elements that have an <sgmltag class="attribute">href</sgmltag> attribute, and returns them in random order.  (That is, the first one you get is not guaranteed to be the first link on the page.)  Then you access each found element with the <methodname>allLinks.snapshotItem(i)</methodname> method.</para>
</example>
<para>XPath expressions can do wonderous things.  Here's one that finds <emphasis>any</emphasis> element that has a <sgmltag class="attribute">title</sgmltag> attribute.</para>
<example id="example.pattern.certainattribute.title">
<title>Find all the elements with a <sgmltag class="attribute">title</sgmltag> attribute</title>
<programlisting><![CDATA[var allElements, thisElement;
allElements = document.evaluate(
    '//*[@title]',
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);
for (var i = 0; i < allElements.snapshotLength; i++) {
    thisElement = allElements.snapshotItem(i);
    switch (thisElement.nodeName.toUpperCase()) {
        case 'A':
            // this is a link, do something
            break;
        case 'IMG':
            // this is an image, do something else
            break;
        default:
            // do something with other kinds of HTML elements
    }
}]]></programlisting>
</example>
<tip>
<title/>
<para>Once you have a reference to an element (like <varname>thisElement</varname>), you can use <property>thisElement.nodeName</property> to determine its &html; tag name.  If the page is served as <systemitem>text/html</systemitem>, the tag name is always returned as uppercase, regardless of how it was specified in the original page.  However, if the page is served as <systemitem>application/xhtml+xml</systemitem>, the tag name is always lowercase.  I always use <function>thisElement.nodeName.toUpperCase()</function> and forget about it.</para>
</tip>
<para>Here's an XPath query that returns every <sgmltag>&lt;div&gt;</sgmltag> with a specific <sgmltag class="attribute">class</sgmltag>.</para>
<example id="example.pattern.certainattribute.sponsoredlink">
<title>Find all <sgmltag>&lt;div&gt;</sgmltag>s with a <sgmltag class="attribute">class</sgmltag> of <literal>sponsoredlink</literal></title>
<programlisting><![CDATA[var allDivs, thisDiv;
allDivs = document.evaluate(
    "//div[@class='sponsoredlink']",
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);
for (var i = 0; i < allDivs.snapshotLength; i++) {
    thisDiv = allDivs.snapshotItem(i);
    // do something with thisDiv
}]]></programlisting>
<para>Note that I used double quotes around the XPath query string, so that I could use single quotes within it.</para>
</example>
<para>There are lots of variations of the <methodname>document.evaluate</methodname> method.  The second parameter (<varname>document</varname> in both of the previous examples) can be any element, and the XPath query will only return nodes that are children of that element.  So if you already have a reference to an element (say, from <methodname>document.getElementById</methodname> or a member of a <methodname>document.getElementsByTagName</methodname> array), you can restrict the query to search only children of that element.</para>
<para>The third parameter is a reference to a namespace resolver function, which is only useful if you care about writing user scripts that work on pages served with the <systemitem>application/xhtml+xml</systemitem> media type.  If you don't know what that means, don't worry about it; there aren't very many pages like that and you probably won't run into one.  <ulink url="&url_mozilla_xpath_documentation;">Mozilla XPath documentation</ulink> explains how to use it, if you really want to know.</para>
<para>The fourth parameter is how you want your results returned.  The previous two examples both use <constant>XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE</constant>, which returns elements in random order.  I use this 99% of the time, but if for some reason you wanted to make sure that you got elements back in exactly the order in which they appear in the page, you can use <constant>XPathResult.ORDERED_NODE_SNAPSHOT_TYPE</constant> instead.  <ulink url="&url_mozilla_xpath_documentation;">Mozilla XPath documentation</ulink> gives examples of some other variations as well.</para>
<para>The fifth parameter can be used to merge the results of two XPath queries.  Pass in the result of a previous call to <methodname>document.evaluate</methodname>, and it will return the combined results of both queries.  The previous two examples both use <constant>null</constant>, meaning that we are only interested in the single XPath query defined in the first parameter.</para>
<para>Got all that?  XPath can be as simple or as complicated as you like.  I urge you to read <ulink url="&url_zvon_xpath_tutorial;">this excellent XPath tutorial</ulink> to learn more about XPath syntax.  As for the other parameters to <methodname>document.evaluate</methodname>, I rarely use them except as you've already seen here.  In fact, you can define a function to encapsulate them.</para>
<example id="example.pattern.xpath.function">
<title>The <function>xpath</function> function</title>
<programlisting><![CDATA[function xpath(query) {
    return document.evaluate(query, document, null,
        XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE, null);
}]]></programlisting>
<para>Now you can simply call <function>xpath('//a[@href]')</function> to get all the links on the page, or <function>xpath('//*[@title]')</function> to get all the elements with a <sgmltag class="attribute">title</sgmltag> attribute.  You'll still need to use the <methodname>snapshotItem</methodname> method to access each item in the results; it's not a regular Javascript array.</para>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_accessbar;">Access Bar</ulink></para></listitem>
<listitem><para><ulink url="&url_example_betterdir;">BetterDir</ulink></para></listitem>
<listitem><para><ulink url="&url_example_blogdexdisplaytitle;">Blogdex Display Title</ulink></para></listitem>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
<listitem><para><ulink url="&url_example_frownies;">Frownies</ulink></para></listitem>
<listitem><para><ulink url="&url_example_offsiteblank;">Offsite Blank</ulink></para></listitem>
<listitem><para><ulink url="&url_example_rottenreviews;">Rotten Reviews</ulink></para></listitem>
<listitem><para><ulink url="&url_example_stopthepresses;">Stop The Presses</ulink></para></listitem>
</itemizedlist>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_mozilla_xpath_documentation;">Mozilla XPath documentation</ulink></para></listitem>
<listitem><para><ulink url="&url_zvon_xpath_tutorial;">XPath tutorial by example</ulink></para></listitem>
<listitem><para><ulink url="&url_xpathresult_reference;">XPathResult reference</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.certainattribute -->

<section id="pattern.insertbefore">
<?dbhtml filename="patterns/insert-before.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Once you've found an element (by any means), you may wish to insert additional content before it.  You can do this with the <function>insertBefore</function> method.</para>
</abstract>
</sectioninfo>
<title>Inserting content before an element</title>
<example id="example.pattern.insert.before">
<title>Insert an <sgmltag>&lt;hr&gt;</sgmltag> before the main content</title>
<para>This presumes that there is an element whose ID is <literal>"main"</literal>.</para>
<programlisting><![CDATA[var main, newElement;
main = document.getElementById('main');
if (main) {
    newElement = document.createElement('hr');
    main.parentNode.insertBefore(newElement, main);
}]]></programlisting>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
<listitem><para><ulink url="&url_example_zoomtextarea;">Zoom Textarea</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.insertbefore -->

<section id="pattern.insertafter">
<?dbhtml filename="patterns/insert-after.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Once you've found an element, you may wish to insert additional content <emphasis>after</emphasis> it.  You can use the <function>insertBefore</function> function for this too, combined with the <property>nextSibling</property> property.</para>
</abstract>
</sectioninfo>
<title>Inserting content after an element</title>
<example id="example.pattern.insert.after">
<title>Insert an <sgmltag>&lt;hr&gt;</sgmltag> after the navigation bar</title>
<para>This presumes that there is an element whose ID is <literal>"navbar"</literal>.</para>
<programlisting><![CDATA[var navbar, newElement;
navbar = document.getElementById('navbar');
if (navbar) {
    newElement = document.createElement('hr');
    navbar.parentNode.insertBefore(newElement, navbar.nextSibling);
}]]></programlisting>
</example>
<tip>
<title/>
<para>Inserting new content before <property>someExistingElement.nextSibling</property> will work even if <varname>someExistingElement</varname> is the last child of its parent (i.e. it has no next sibling).  In this case, <property>someExistingElement.nextSibling</property> will return <constant>null</constant>, and the <function>insertBefore</function> function will simply append the new content after all other siblings.  (If this doesn't make any sense to you, don't worry about it.  The point is that this example will always work, even when it seems like it shouldn't.)</para>
</tip>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_blogdexdisplaytitle;">Blogdex Display Title</ulink></para></listitem>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.insertafter -->

<section id="pattern.removeelement">
<?dbhtml filename="patterns/remove-element.html"?>
<sectioninfo>
<abstract>
<title/>
<para>You can use Greasemonkey to remove entire chunks of a page in one fell swoop, with the <function>removeChild</function> function.</para>
</abstract>
</sectioninfo>
<title>Removing an element</title>
<example id="example.pattern.remove">
<title>Remove an ad sidebar</title>
<para>This presumes that there is an element whose ID is <literal>"ads"</literal>.</para>
<programlisting><![CDATA[var adSidebar = document.getElementById('ads');
if (adSidebar) {
    adSidebar.parentNode.removeChild(adSidebar);
}]]></programlisting>
</example>
<note>
<title/>
<para>Removing an element with <methodname>removeChild</methodname> will also remove all the content inside it.  For example, if you remove a <sgmltag>&lt;table&gt;</sgmltag> element, this will also remove all of its table cells (<sgmltag>&lt;td&gt;</sgmltag> elements).</para>
</note>
<tip>
<title/>
<para>If all you want to do is remove ads, it's probably easier to install <ulink url="&url_adblock;">AdBlock</ulink> and import <ulink url="&url_adblock_filterlist;">an up-to-date filter list</ulink> than to write your own user script.</para>
</tip>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.removeelement -->

<section id="pattern.replaceelement">
<?dbhtml filename="patterns/replace-element.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Once you find an element, you can replace it with entirely new content, using the <function>replaceChild</function> function.</para>
</abstract>
</sectioninfo>
<title>Replacing an element with new content</title>
<example id="example.pattern.replacechild">
<title>Replace an image with its alt text</title>
<para>This presumes that there is an element whose ID is <literal>"annoyingsmily"</literal>.</para>
<programlisting><![CDATA[var theImage, altText;
theImage = document.getElementById('annoyingsmily');
if (theImage) {
    altText = document.createTextNode(theImage.alt);
    theImage.parentNode.replaceChild(altText, theImage);
}]]></programlisting>
</example>
<note>
<title/>
<para>If you want to replace an element with a large chunk of &html;, you can construct the &html; as a string and then <link linkend="pattern.innerhtml">set the element's <property>innerHTML</property> property</link>.</para>
</note>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_frownies;">Frownies</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.replaceelement -->

<section id="pattern.innerhtml">
<?dbhtml filename="patterns/innerhtml.html"?>
<sectioninfo>
<abstract>
<title/>
<para>The <property>innerHTML</property> property allows you to construct &html; as a string and then insert it directly into the page, without constructing separate DOM objects for each &html; element and setting their attributes one by one.</para>
</abstract>
</sectioninfo>
<title>Inserting complex &html; quickly</title>
<example id="example.pattern.innerhtml">
<title>Insert a banner at the top of the page</title>
<programlisting><![CDATA[var logo = document.createElement("div");
logo.innerHTML = '<div style="margin: 0 auto 0 auto; ' +
    'border-bottom: 1px solid #000000; margin-bottom: 5px; ' +
    'font-size: small; background-color: #000000; ' +
    'color: #ffffff;"><p style="margin: 2px 0 1px 0;"> ' +
    'YOUR TEXT HERE ' +
    '</p></div>';
document.body.insertBefore(logo, document.body.firstChild);]]></programlisting>
<para>The key here is the second line, where I set <property>logo.innerHTML</property> to a string.  Firefox parses the string as &html; and creates all the necessary objects, just like it does for the entire page when it first loads.  Then I can insert my new <varname>logo</varname> (a <sgmltag>&lt;div&gt;</sgmltag> containing another <sgmltag>&lt;div&gt;</sgmltag> containing a <sgmltag>&lt;p&gt;</sgmltag>) into the page at any point &#8212; at the beginning of the page, at the end, or <link linkend="pattern.insertbefore">before</link> or <link linkend="pattern.insertafter">after</link> any element I choose.  In other words, anywhere on the page.</para>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_accessbar;">Access Bar</ulink></para></listitem>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
<listitem><para><ulink url="&url_example_betterdir;">BetterDir</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.innerhtml -->

<section id="pattern.addimage">
<?dbhtml filename="patterns/add-image.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Firefox supports <systemitem>data:</systemitem> &url;s, which are a way to embed chunks of data into a &url; instead of retrieving the data from the server in a separate call.  You've probably never heard of <systemitem>data:</systemitem> &url;s because Internet Explorer doesn't support them, so no one uses them.  But they can come in handy in user scripts.</para>
</abstract>
</sectioninfo>
<title>Adding images without hitting a central server</title>
<example id="example.pattern.datauri">
<title>Add a graphical logo at the top of the page</title>
<programlisting><![CDATA[var logo = document.createElement('img');
logo.src = 'data:image/gif;base64,R0lGODlhDQAOAJEAANno6wBmZgAAAAAAACH5BAAAAAAA'+
    'LAAAAAANAA4AQAIjjI8Iyw3GhACSQecutsFV3nzgNi7SVEbo06lZa66LRib2UQAAOw%3D%3D';
document.body.insertBefore(logo, document.body.firstChild);]]></programlisting>
<para>In this example, the <sgmltag class="attribute">src</sgmltag> of the <sgmltag>&lt;img&gt;</sgmltag> element is a <systemitem>data:</systemitem> &url; which contains the entire image data in encoded form.  Once the new element is inserted into the page, it will display just like any other image, but without requiring that the image be stored on a central server.  In essence, you can embed images in your user scripts and distribute them as part of the same file as the rest of your code.</para>
</example>
<tip>
<title/>
<para>Use the <ulink url="&url_data_uri_kitchen;"><systemitem>data:</systemitem> &uri; kitchen</ulink> to construct your own <systemitem>data:</systemitem> &url;s.</para>
</tip>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
<listitem><para><ulink url="&url_example_zoomtextarea;">Zoom Textarea</ulink></para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><ulink url="&url_data_uri_kitchen;"><systemitem>data:</systemitem> &uri; kitchen</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.addimage -->

<section id="pattern.addcss">
<?dbhtml filename="patterns/add-css.html"?>
<sectioninfo>
<abstract>
<title/>
<para>I have often found the need to add my own CSS styles to a page.  You can add styles that override existing styles, or styles specific to new elements that your user script inserts.</para>
</abstract>
</sectioninfo>
<title>Adding CSS styles</title>
<example id="example.pattern.css">
<title>Make paragraph text larger</title>
<programlisting><![CDATA[function addGlobalStyle(css) {
    var head, style;
    head = document.getElementsByTagName('head')[0];
    if (!head) { return; }
    style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = css;
    head.appendChild(style);
}

addGlobalStyle('p { font-size: large ! important; }');]]></programlisting>
<para>This function takes one argument, a string containing the style rules you want to add to the page.  It works by quite literally injecting a <sgmltag>&lt;style&gt;</sgmltag> element into the page's <sgmltag>&lt;head&gt;</sgmltag> section that contains your style rules.  Firefox automatically picks up the change, parses the style rules, and applies them to the page.  You may include as many separate style rules as you like in a single function call; just concatenate them together as a string and pass them all at once.</para>
</example>
<tip>
<title/>
<para>You can use the <function>addGlobalStyle</function> function to style elements that you insert into a page, or elements that were part of the original page. However, if you are styling existing elements, you should use the <literal>! important</literal> keyword for each rule you define to ensure your styles override the rules defined by the original page.</para>
</tip>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_accessbar;">Access Bar</ulink></para></listitem>
<listitem><para><ulink url="&url_example_aintitreadable;">Aint It Readable</ulink></para></listitem>
<listitem><para><ulink url="&url_example_betterdir;">BetterDir</ulink></para></listitem>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
<listitem><para><ulink url="&url_example_cdreadable;">CDReadable</ulink></para></listitem>
<listitem><para><ulink url="&url_example_lip;">LIP</ulink></para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="casestudy.aintitreadable"/></para></listitem>
</itemizedlist>
</section> <!-- pattern.addcss -->

<section id="pattern.getcomputedstyle">
<?dbhtml filename="patterns/getcomputedstyle.html"?>
<sectioninfo>
<abstract>
<title/>
<para>It is occasionally useful to get a specific element's actual style, after all CSS rules have been applied.  You might naively assume that an element's <property>style</property> property will give you this, but you would be mistaken.  That only returns the contents of the element's <sgmltag class="attribute">style</sgmltag> attribute.  To get the final style (including any styles defined in external stylesheets), you need to use the <function>getComputedStyle</function> function.</para>
</abstract>
</sectioninfo>
<title>Getting an element's style</title>
<para>To illustrate this, let's create a simple test page.  It defines a style for all <sgmltag>&lt;p&gt;</sgmltag> elements, but then one of the <sgmltag>&lt;p&gt;</sgmltag> elements overrides that with its <sgmltag class="attribute">style</sgmltag> attribute.</para>
<informalexample>
<programlisting><![CDATA[<html>
<head>
<title>Style test page</title>
<style type="text/css">
p { background-color: white; color: red; }
</style>
</head>
<body>
<p id="p1">This line is red.</p>
<p id="p2" style="color: blue">This line is blue.</p>
</body>
</html>]]></programlisting>
</informalexample>
<example id="example.antipattern.style">
<title>Get the styles defined by an element's <sgmltag class="attribute">style</sgmltag> attribute</title>
<programlisting><![CDATA[var p1elem, p2elem;
p1elem = document.getElementById('p1');
p2elem = document.getElementById('p2');
alert(p1elem.style.color); // will display an empty string
alert(p2elem.style.color); // will display "blue"]]></programlisting>
</example>
<para>That wasn't terribly helpful, and you should never use <varname>element</varname>.<methodname>style</methodname> to get individual styles.  (You can use it to <emphasis>set</emphasis> individual styles; see <xref linkend="pattern.setstyle"/>.)</para>
<para>So what should you use instead?  <methodname>getComputedStyle()</methodname>.</para>
<example id="example.pattern.getcomputedstyle">
<title>Get the actual style of an element</title>
<programlisting><![CDATA[var p1elem, p2elem, p1style, p2style;
p1elem = document.getElementById('p1');
p2elem = document.getElementById('p2');
p1style = getComputedStyle(p1elem, '');
p2style = getComputedStyle(p2elem, '');
alert(p1style.color); // will display "rgb(255, 0, 0)"
alert(p2style.color); // will display "rgb(0, 0, 255)"]]></programlisting>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_butler;">Butler</ulink></para></listitem>
<listitem><para><ulink url="&url_example_zoomtextarea;">Zoom Textarea</ulink></para></listitem>
</itemizedlist>
</section>

<section id="pattern.setstyle">
<?dbhtml filename="patterns/set-style.html"?>
<sectioninfo>
<abstract>
<title/>
<para>If you only need to set a few styles on a single element, you can do this <quote>manually</quote> by setting various subproperties on the element's <property>style</property> property.</para>
</abstract>
</sectioninfo>
<title>Setting an element's style</title>
<example id="example.pattern.setstyle">
<title>Setting style on a single element</title>
<para>This presumes that there is an element whose ID is <literal>"logo"</literal>.</para>
<programlisting><![CDATA[var logo = document.getElementById('logo');
logo.style.marginTop = '2em';
logo.style.backgroundColor = 'white';
logo.style.color = 'red';]]></programlisting>
</example>
<warning>
<title/>
<para>The property names of individual styles are not always obvious.  Generally, they follow the same pattern, where <property>margin-top</property> becomes <property>someElement.style.marginTop</property>.  But there are exceptions: the <property>float</property> property is set with <property>someElement.style.cssFloat</property>, since <quote>float</quote> is a reserved word in Javascript.</para>
</warning>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_accessbar;">Access Bar</ulink></para></listitem>
<listitem><para><ulink url="&url_example_betterdir;">BetterDir</ulink></para></listitem>
<listitem><para><ulink url="&url_example_blogdexdisplaytitle;">Blogdex Display Title</ulink></para></listitem>
<listitem><para><ulink url="&url_example_zoomtextarea;">Zoom Textarea</ulink></para></listitem>
</itemizedlist>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_cssproperties;">CSS properties</ulink></para></listitem>
</itemizedlist>
</section>

<section id="pattern.postprocess">
<?dbhtml filename="patterns/onload.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Because of how Firefox stores a rendered page internally, large changes to the page's DOM should be done <emphasis>after</emphasis> the page is finished loading.  You can delay processing of a function using the <function>addEventListener</function> function.</para>
</abstract>
</sectioninfo>
<title>Post-processing a page after it renders</title>
<example id="example.pattern.addeventlistener">
<title>Replace an entire page with custom content</title>
<programlisting><![CDATA[var newBody = 
'<html>' +
'<head>' +
'<title>My New Page</title>' +
'</head>' +
'<body>' +
'<p>This page is a complete replacement of the original.</p>' +
'</body>' +
'</html>';
window.addEventListener(
    'load', 
    function() { document.body.innerHTML = newBody; },
    true);]]></programlisting>
</example>
<para>Looking closely at this code, you might naturally wonder why it works at all.  I am declaring an anonymous function to pass as the second argument to <methodname>window.addEventListener</methodname>, which accesses the <varname>newBody</varname> variable defined in the outer function.  This is called a <quote>closure</quote>, and is perfectly legal in Javascript.  In general, an <quote>inner</quote> function defined within an <quote>outer</quote> function can access all of the outer function's local variables -- even after the outer function finishes executing.  This is a very powerful feature that makes it possible to create event handlers and other functions that contain data structures constructed at runtime.</para>
<tip>
<title/>
<para>Zapping and replacing <property>document.body.innerHTML</property> does not change everything about the page.  Anything defined in the <sgmltag>&lt;head&gt;</sgmltag> of the original page will still be in effect, including the page title, CSS styles, and scripts.  You can modify or remove these separately.</para>
</tip>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_accessbar;">Access Bar</ulink></para></listitem>
<listitem><para><ulink url="&url_example_betterdir;">BetterDir</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.postprocess -->

<section id="pattern.caseinsensitive">
<?dbhtml filename="patterns/case-insensitive.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Many attribute values in &html; are case-insensitive.  Many can also contain leading and trailing spaces.  If you want to find all variations, you need to do a little legwork in your XPath queries.</para>
</abstract>
</sectioninfo>
<title>Matching case-insensitive attribute values</title>
<example id="example.pattern.caseinsensitive">
<title>Find all forms whose method is "POST" or "post"</title>
<programlisting><![CDATA[var postforms = document.evaluate(
    "//form[translate(@method, 'POST ', 'post')='post']",
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);]]></programlisting>
<para>This XPath query finds forms that submit with a POST method.  First, we need to translate the <sgmltag class="attribute">method</sgmltag> attribute to lowercase, using the <function>translate</function> function to convert uppercase letters to lowercase.  (XPath 2.0 has a <function>lowercase</function> function, but I didn't have any success using it.)  Second, we need to strip leading and trailing spaces.  We can incorporate this into our call to the <function>translate</function> function by including an extra space in the first argument.  Since there is no corresponding letter in the second argument, all spaces are stripped.  Finally, we can compare the resulting attribute value to <literal>'post'</literal>.</para>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_forceget;">ForceGet</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.caseinsensitive -->

<section id="pattern.getdomain">
<?dbhtml filename="patterns/get-domain.html"?>
<sectioninfo>
<abstract>
<title/>
<para>User scripts that operate on multiple domains (or all domains) frequently need to detect the domain of the current page.  You can use <property>window.location.href</property> to get the full &url; of the current page, or <property>window.location.host</property> to get just the domain name by itself.</para>
</abstract>
</sectioninfo>
<title>Getting the current domain name</title>
<example id="example.pattern.getdomain">
<title>Get the current domain</title>
<programlisting><![CDATA[var href = window.location.host;]]></programlisting>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_offsiteblank;">Offsite Blank</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.getdomain -->

<section id="pattern.rewritelinks">
<?dbhtml filename="patterns/rewrite-link.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Once you find a link on a page, you can rewrite it by setting its <property>href</property> attribute.</para>
</abstract>
</sectioninfo>
<title>Rewriting links</title>
<example id="example.pattern.rewritelinks">
<title>Add a query parameter to the end of a link</title>
<para>This presumes that there is a link with the id <sgmltag class="attribute">"article"</sgmltag>.</para>
<programlisting><![CDATA[var a = document.getElementById('article');
if (a.href.match(/\?/i)) {
    // link already contains other parameters, so append "&amp;printer=1"
    a.href += '&amp;printer=1';
} else {
    // link does not contain any parameters, so append "?printer=1"
    a.href += '?printer=1';
}]]></programlisting>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_rottenreviews;">Rotten Reviews</ulink></para></listitem>
<listitem><para><ulink url="&url_example_stopthepresses;">Stop The Presses</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.rewritelinks -->

<section id="pattern.redirect">
<?dbhtml filename="patterns/redirect.html"?>
<sectioninfo>
<abstract>
<title/>
<para>You can use Greasemonkey to automatically redirect certain pages, by setting the <property>window.location.href</property> property.</para>
</abstract>
</sectioninfo>
<title>Redirecting pages</title>
<example id="example.pattern.redirect">
<title>Redirect a site to its secure counterpart</title>
<programlisting><![CDATA[window.location.href = window.location.href.replace(/^http:/, 'https:');]]></programlisting>
</example>
<itemizedlist role="usedby">
<title>Real examples</title>
<listitem><para><ulink url="&url_example_gmailsecure;">GMail Secure</ulink></para></listitem>
<listitem><para><ulink url="&url_example_salonautopass;">Salon Auto-Pass</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.redirect -->

<section id="pattern.interceptclicks">
<?dbhtml filename="patterns/intercept-clicks.html"?>
<sectioninfo>
<abstract>
<title/>
<para>While <link linkend="pattern.rewritelinks">rewriting links is easy</link>, you can go one step further and trap every click, anywhere on the page, by using the <function>addEventListener</function> function.  (This also traps clicks on links.)  You can then calculate what to do: whether to allow the click to <quote>fall through</quote> to the clicked element, or do something else entirely.</para>
</abstract>
</sectioninfo>
<title>Intercepting user clicks</title>
<example id="example.pattern.interceptclicks">
<title>Do something when the user clicks anywhere on the page</title>
<programlisting><![CDATA[document.addEventListener('click', function(event) {
    // event.target is the element that was clicked

    // do whatever you want here

    // if you want to prevent the default click action
    // (such as following a link), use these two commands:
    event.stopPropagation();
    event.preventDefault();
}, true);]]></programlisting>
<para>Note the use of an <link linkend="first.helloworld">anonymous function</link> passed as an argument to the <function>document.addEventListener</function> function.</para>
</example>
</section> <!-- pattern.interceptclicks -->

<section id="pattern.overridemethod">
<?dbhtml filename="patterns/override-method.html"?>
<sectioninfo>
<abstract>
<title/>
<para>You can use the <property>prototype</property> property to override a native object's method.</para>
</abstract>
</sectioninfo>
<title>Overriding a built-in Javascript method</title>
<example id="example.pattern.prototype">
<title>Do something before a form is submitted</title>
<programlisting><![CDATA[function newsubmit(event) {
    var target = event ? event.target : this;

    // do anything you like here
    alert('Submitting form to ' + target.action);

    // call real submit function
    this._submit();
}

// capture the onsubmit event on all forms
window.addEventListener('submit', newsubmit, true);

// If a script calls someForm.submit(), the onsubmit event does not fire,
// so we need to redefine the submit method of the HTMLFormElement class.
HTMLFormElement.prototype._submit = HTMLFormElement.prototype.submit;
HTMLFormElement.prototype.submit = newsubmit;]]></programlisting>
<para>There are two things going on here.  First, I am adding an event listener that traps &submit; events.  A &submit; event occurs when the user clicks a Submit button on a form.  However, if another script manually calls the <methodname>submit()</methodname> method of a form, the &submit; event does not fire.  So, the second thing I do is override the <methodname>submit</methodname> method of the <classname>HTMLFormElement</classname> class.</para>
<para>But wait, there's more.  Both the event listener and the method override point to the same function, <function>newsubmit</function>.  If <function>newsubmit</function> gets called via a &submit; event, the <varname>event</varname> argument will be populated with an event object that contains information about the event (for example, <property>event.target</property> will be the form being submitted).  However, if a script manually calls the <methodname>submit</methodname> method, the <varname>event</varname> argument will be missing, but the global variable <varname>this</varname> will point to the form.  Therefore, in my <function>newsubmit</function> function, I test whether <varname>event</varname> is null, and if so, get the target form from <varname>this</varname> instead.</para>
</example>
<tip>
<title/>
<para>A &submit; event fires when a user submits a form in the usual way, i.e. by clicking the form's <guibutton>Submit</guibutton> button or hitting <userinput>ENTER</userinput> within a form.  However, the &submit; event <emphasis>does not</emphasis> fire when the form is submitted via a script calling <function>aForm.submit()</function>.  Therefore you need to do two things to capture a form submission: add an event listener to capture to &submit; event, <emphasis>and</emphasis> modify the prototype of the <classname>HTMLFormElement</classname> class to redirect the <methodname>submit()</methodname> method to your custom function.</para>
</tip>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_jseventcompatibility;">Javascript event compatibility tables</ulink></para></listitem>
<listitem><para><ulink url="&url_jsdomprototypes;">Javascript-DOM prototypes in Mozilla</ulink></para></listitem>
<listitem><para><ulink url="&url_eventobjects;">Displaying Event object constants</ulink></para></listitem>
</itemizedlist>
</section> <!-- pattern.overridemethod -->

<section id="pattern.parsexml">
<?dbhtml filename="patterns/parse-xml.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Firefox automatically parses the current page into a DOM, but you can also manually create a DOM out of any &xml; string, either one you constructed yourself, or &xml; that you retrieved from a remote location.</para>
</abstract>
</sectioninfo>
<title>Parsing &xml;</title>
<example id="example.pattern.parsexml.string">
<title>Parse an arbitrary string as &xml;</title>
<programlisting><![CDATA[var xmlString = '<passwd>' + 
'  <user id="101">' +
'    <login>mark</login>' + 
'    <group id="100"/>' +
'    <displayname>Mark Pilgrim</displayname>' + 
'    <homedir>/home/mark/</homedir>' +
'    <shell>/bin/bash</shell>' +
'  </user>' +
'</passwd>'
var parser = new DOMParser();
var xmlDoc = parser.parseFromString(xmlString, "application/xml");]]></programlisting>
<para>The key here is the <classname>DOMParser</classname> object, which contains the <methodname>parseFromString</methodname> method.  (It contains other methods too, but they are not useful to us here.)  Its <methodname>parseFromString</methodname> method takes two arguments: the &xml; string to parse, and the content type.  Both arguments are required.</para>
</example>
<note>
<title/>
<para>The <classname>DOMParser</classname>'s <methodname>parseFromString</methodname> method takes a content type as its second parameter.  The method accepts <systemitem>application/xml</systemitem>, <systemitem>application/xhtml+xml</systemitem>, and <systemitem>text/xml</systemitem>.  For reasons that are too ridiculous to go into, you should always use <systemitem>application/xml</systemitem>.</para>
</note>
<para>This pattern is especially powerful when you combine it with the <function>GM_xmlhttpRequest</function> function to parse &xml; from a remote source.</para>
<example id="example.pattern.parsexml.url">
<title>Parse &xml; from a remote source</title>
<programlisting><![CDATA[GM_xmlhttpRequest({
    method: 'GET',
    url: 'http://greaseblog.blogspot.com/atom.xml',
    headers: {
        'User-agent': 'Mozilla/4.0 (compatible) Greasemonkey/0.3',
        'Accept': 'application/atom+xml,application/xml,text/xml',
    },
    onload: function(responseDetails) {
        var parser = new DOMParser();
        var dom = parser.parseFromString(responseDetails.responseText,
            "application/xml");
        var entries = dom.getElementsByTagName('entry');
        var title;
        for (var i = 0; i < entries.length; i++) {
            title = entries[i].getElementsByTagName('title')[0].textContent;
            alert(title);
        }
    }
});]]></programlisting>
<para>This code will load the Atom feed from <ulink url="&url_greaseblog_feed;"/>, parse it into a DOM, and query the DOM to get the list of entries.  For each entry, it queries the DOM again to get the entry title, then displays it in a dialog box.</para>
</example>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="pattern.oneelement"/></para></listitem>
<listitem><para><xref linkend="api.gmxmlhttprequest"/></para></listitem>
</itemizedlist>
</section>

</chapter> <!-- pattern -->

<chapter id="casestudy">
<?dbhtml filename="casestudy/index.html"?>
<title>Case Studies</title>

<section id="casestudy.gmailsecure">
<?dbhtml filename="casestudy/gmailsecure.html"?>
<sectioninfo>
<abstract>
<title/>
<para>GMail Secure forces <ulink url="&url_gmail;">GMail</ulink> to use a secure connection, by redirecting <systemitem>&url_gmail;</systemitem> to <systemitem>&url_gmailhttps;</systemitem>.</para>
</abstract>
</sectioninfo>
<title>Case study: GMail Secure</title>
<subtitle>Forcing a site to use a secure connection</subtitle>
<para>Google offers <ulink url="&url_gmail;">GMail</ulink>, their webmail service, through an unsecured connection (an <systemitem>http://</systemitem> address) or a secure connection (an <systemitem>https://</systemitem> address).  I could try to remember to always use the secure connection when I'm checking my email on a public network (such as an Internet cafe), but why bother when my computer can do remember it for me?  I wrote a user script that detects when I'm attempting to use GMail over an unsecure connection and redirects me to the secure site instead.</para>
<example id="example.casestudy.gmail">
<title>Redirect GMail to an equivalent <systemitem>https://</systemitem> address</title>
<programlisting><![CDATA[// ==UserScript==
// @name          GMailSecure
// @namespace     http://diveintogreasemonkey.org/download/
// @description   force GMail to use secure connection
// @include       http://gmail.google.com/*
// ==/UserScript==

window.location.href = window.location.href.replace(/^http:/, 'https:');]]></programlisting>
</example>
<para>This user script is very simple.  Most of the <quote>work</quote> is accomplished by the <literal>@include</literal> line:</para>
<informalexample>
<programlisting><![CDATA[// @include       http://gmail.google.com/*]]></programlisting>
</informalexample>
<para>This user script only runs if the <literal>@include</literal> matches, so if the script is running, I already know I'm in the wrong place (in the sense that I'm using GMail over an insecure connection).  Given that, accomplishing my goal is a single line of code, to redirect the current page to the same &url;, but with an <systemitem>https://</systemitem> prefix instead of <systemitem>http://</systemitem>.</para>
<informalexample>
<programlisting><![CDATA[window.location.href = window.location.href.replace(/^http:/, 'https:');]]></programlisting>
</informalexample>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="pattern.redirect"/></para></listitem>
</itemizedlist>
</section> <!-- casestudy.gmailsecure -->

<section id="casestudy.autoload">
<?dbhtml filename="casestudy/bloglinesautoload.html"?>
<sectioninfo>
<abstract>
<title/>
<para><ulink url="&url_bloglines;">Bloglines</ulink> is a web-based aggregator for syndicated feeds.  It has a 2-pane interface; the left-hand pane displays your subscriptions, and the right-hand pane displays the content from those subscriptions.  It's a very nice interface; the only thing I dislike about it is that I always use it the same way: every time I visit Bloglines, I want to see everything I haven't seen before, that is, all the unread items.</para>
</abstract>
</sectioninfo>
<title>Case study: Bloglines Autoload</title>
<subtitle>Automating page actions</subtitle>
<para>In Bloglines, displaying all unread items is just one click away.  Clicking on the root level of your subscriptions in the lefthand pane, and it displays the unread items in the righthand pane.  But since I always want to do this, I wrote a user script to automate that one click.</para>
<example id="example.casestudy.bloglines">
<title>Make Bloglines display all unread items automatically</title>
<programlisting><![CDATA[// ==UserScript==
// @name          Bloglines Autoloader
// @namespace     http://diveintogreasemonkey.org/download/
// @description   Auto-display all new items in Bloglines
// @include       http://bloglines.com/myblogs*
// @include       http://www.bloglines.com/myblogs*
// ==/UserScript==

if (doLoadAll) {
    doLoadAll();
}]]></programlisting>
</example>
<para>This user script is quite simple.  Bloglines defines a function, <function>doLoadAll()</function>, which is what would get executed if I manually clicked on the root level of my subscriptions list.  Calling the function displays all unread items.</para>
<para>However, since Bloglines uses frames, the user script will end up getting executed in each frame (since they all match the pattern I've defined in the <literal>@include</literal>), so I first need to check whether the <function>doLoadAll()</function> function exists in this frame:</para>
<informalexample>
<programlisting><![CDATA[if (doLoadAll) {]]></programlisting>
</informalexample>
<para>Assumes the function exists, I simply call it.  Since the user script runs in the same context as the page, I can call any scripts that the original page has defined.</para>
<informalexample>
<programlisting><![CDATA[    doLoadAll();
    }]]></programlisting>
</informalexample>
<itemizedlist role="download">
<title>Download</title>
<listitem><para><ulink url="&url_example_bloglinesautoload;"><filename>bloglines-autoload.user.js</filename></ulink></para></listitem>
</itemizedlist>
</section> <!-- casestudy.autoload -->

<section id="casestudy.aintitreadable">
<?dbhtml filename="casestudy/aintitreadable.html"?>
<sectioninfo>
<abstract>
<title/>
<para><ulink url="&url_aintitcoolnews;">Ain't It Cool News</ulink> is a site devoted to entertainment news.  The site is wonderful; I highly recommend it.  Unfortunately, I can't stand how the site looks.  Every headline is too large, too bold, and changes color as you move your cursor over it.  So I wrote a user script that changes the styles I don't like.</para>
</abstract>
</sectioninfo>
<title>Case study: Ain't It Readable</title>
<subtitle>Overriding page styles</subtitle>
<example id="example.casestudy.aintitreadable">
<title><ulink url="&url_example_aintitreadable;" type="Download Ain't It Readable"><filename>aintitreadable.user.js</filename></ulink></title>
<programlisting><![CDATA[// ==UserScript==
// @name          Ain't It Readable
// @namespace     http://diveintogreasemonkey.org/download/
// @description   change style on aint-it-cool-news.com
// @include       http://aint-it-cool-news.com/*
// @include       http://*.aint-it-cool-news.com/*
// ==/UserScript==

function addGlobalStyle(css) {
    var head, style;
    head = document.getElementsByTagName('head')[0];
    if (!head) { return; }
    style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = css;
    head.appendChild(style);
}

addGlobalStyle(
'h1, h2, h3, h4 {' +
'  font-size: 12px ! important;' +
'  line-height: 14px ! important;' +
'  font-weight: normal ! important;' +
'}' +
'h1:hover, h2:hover, h3:hover, h4:hover {' +
'  background-color: inherit ! important;' +
'  color: inherit ! important;' +
'}');]]></programlisting>
</example>
<para>This user script is very simple.  First I define a function which adds arbitrary CSS styles to the page.  See <xref linkend="pattern.addcss"/> for more information about this function.</para>
<informalexample>
<programlisting><![CDATA[function addGlobalStyle(css) {
    var head, style;
    head = document.getElementsByTagName('head')[0];
    if (!head) { return; }
    style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = css;
    head.appendChild(style);
}]]></programlisting>
</informalexample>
<para>Then I simply call the function with the CSS styles I want to add: make the headlines smaller and not bold, and remove the color change when you move the cursor over them.  In this case, the page defines style rules for each of these, so I use the <constant>! important</constant> keyword to make sure that my style rules are applied instead of the page's original rules.</para>
<para>Note that the function takes only one argument, a string that contains all the style rules to add.  I've formatted the string for readability here, but it's still just a string.</para>
<informalexample>
<programlisting><![CDATA[addGlobalStyle(
'h1, h2, h3, h4 {' +
'  font-size: 12px ! important;' +
'  line-height: 14px ! important;' +
'  font-weight: normal ! important;' +
'}' +
'h1:hover, h2:hover, h3:hover, h4:hover {' +
'  background-color: inherit ! important;' +
'  color: inherit ! important;' +
'}');]]></programlisting>
</informalexample>
<itemizedlist role="download">
<title>Download</title>
<listitem><para><ulink url="&url_example_aintitreadable;"><filename>aintitreadable.user.js</filename></ulink></para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="pattern.addcss"/></para></listitem>
</itemizedlist>
</section> <!-- casestudy.aintitreadable -->

<section id="casestudy.offsiteblank">
<?dbhtml filename="casestudy/offsiteblank.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Offsite Blank is a user script that I wrote after someone posted a request to the Greasemonkey script repository.  I personally like to open links in a new tab in the current window, but other people prefer to open a separate window for each site.  Offsite Blank lets you do this automatically, by forcing offsite links to open in a new window.</para>
</abstract>
</sectioninfo>
<title>Case study: Offsite Blank</title>
<subtitle>Forcing offsite links to open in a new window</subtitle>
<example id="example.casestudy.offsiteblank">
<title><ulink url="&url_example_offsiteblank;" type="Download Offsite Blank"><filename>offsiteblank.user.js</filename></ulink></title>
<programlisting><![CDATA[// ==UserScript==
// @name          Offsite Blank
// @namespace     http://diveintogreasemonkey.org/download/
// @description   force offsite links to open in a new window
// @include       http://*
// @include       https://*
// ==/UserScript==

var a, thisdomain, links;
thisdomain = window.location.host;
links = document.getElementsByTagName('a');
for (var i = 0; i < links.length; i++) {
    a = links[i];
    if (a.host && a.host != thisdomain) {
        a.target = "_blank";
    }
}]]></programlisting>
</example>
<para>First, I declare that this user script should run on every web page (but not, for example, on &html; documents stored on your local machine that you open from the <menuchoice><guimenu><accel>F</accel>ile</guimenu><guimenuitem><accel>O</accel>pen</guimenuitem></menuchoice> menu).</para>
<informalexample>
<programlisting><![CDATA[// @include       http://*
// @include       https://*]]></programlisting>
</informalexample>
<para>The code breaks down into four steps:</para>
<orderedlist>
<listitem><para>Get the domain of the current page.</para></listitem>
<listitem><para>Get a list of all the links on the page.</para></listitem>
<listitem><para>Compare the domain of each link to the domain of the page.</para></listitem>
<listitem><para>If the domains don't match, set the target of the link so it opens in a new window.</para></listitem>
</orderedlist>
<para>Getting the domain of the current page is easy.  See <xref linkend="pattern.getdomain"/> for more information.</para>
<informalexample>
<programlisting><![CDATA[thisdomain = window.location.host;]]></programlisting>
</informalexample>
<para>Getting a list of all the links on the page is equally easy, although I should note that I am ignoring <link linkend="example.pattern.certainattribute.a.href">my own advice</link> and simply using <methodname>document.getElementsByTagName('a')</methodname> instead of doing an XPath query.  To-may-to, to-mah-to...</para>
<informalexample>
<programlisting><![CDATA[links = document.getElementsByTagName('a');]]></programlisting>
</informalexample>
<para>Next I loop through all the links (well, all the <sgmltag>&lt;a&gt;</sgmltag> elements, some of which might be links) and check whether the domain of the link matches the domain of the current page.  Because some links might point to non-&http; &url;s (for example, they could point to a local file, or to an &ftp; server), I need to check whether <property>a.host</property> exists, then check whether it's equal to the current domain.</para>
<informalexample>
<programlisting><![CDATA[for (var i = 0; i < links.length; i++) {
    a = links[i];
    if (a.host && a.host != thisdomain) {
        ...
    }]]>
</programlisting>
</informalexample>
<para>If I find a link that has a domain but isn't the same as the current domain, I simply set its <property>target</property> attribute to <literal>"_blank"</literal> to force the link to open in a new window.</para>
<informalexample>
<programlisting><![CDATA[        a.target = "_blank";]]></programlisting>
</informalexample>
<itemizedlist role="download">
<title>Download</title>
<listitem><para><ulink url="&url_example_offsiteblank;"><filename>offsiteblank.user.js</filename></ulink></para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="pattern.getdomain"/></para></listitem>
<listitem><para><xref linkend="pattern.oneelement"/></para></listitem>
<listitem><para><xref linkend="pattern.certainattribute"/></para></listitem>
</itemizedlist>
</section> <!-- casestudy.offsiteblank -->

<section id="casestudy.dumbquotes">
<?dbhtml filename="casestudy/dumbquotes.html"?>
<sectioninfo>
<abstract>
<title/>
<para>DumbQuotes was born out of a frustration shared by many webloggers: most publishing software can automatically convert straight &ascii; quotes to <quote>smart quotes</quote>, but the same software is stupid about handling <quote>smart quotes</quote> when an author copies and pastes them into an article.  A common example is a blogger who wants to quote a passage from another site.  They select a few sentences in their web browser, paste it into a web form to post to their own site, and the passage they pasted ends up looking nothing like the original site because their publishing software doesn't track character encoding properly.</para>
</abstract>
</sectioninfo>
<title>Case study: Dumb Quotes</title>
<subtitle>Converting smart quotes to dumb quotes</subtitle>
<para>Well, I can't fix every publishing system in the world, but I can fix the problem for myself by writing a user script that automatically converts smart quotes and other problematic high-bit characters to their 7-bit &ascii; equivalent.</para>
<example id="example.casestudy.dumbquotes">
<title><ulink url="&url_example_dumbquotes;" type="Download Dumb Quotes"><filename>dumbquotes.user.js</filename></ulink></title>
<programlisting><![CDATA[// ==UserScript==
// @name          DumbQuotes
// @namespace     http://diveintogreasemonkey.org/download/
// @description   straighten curly quotes and apostrophes, simplify fancy dashes, etc.
// @include       *
// ==/UserScript==

var replacements, regex, key, textnodes, node, s;

replacements = {
    "\xa0": " ",
    "\xa9": "(c)",
    "\xae": "(r)",
    "\xb7": "*",
    "\u2018": "'",
    "\u2019": "'",
    "\u201c": '"',
    "\u201d": '"',
    "\u2026": "...",
    "\u2002": " ",
    "\u2003": " ",
    "\u2009": " ",
    "\u2013": "-",
    "\u2014": "--",
    "\u2122": "(tm)"};
regex = {};
for (key in replacements) {
    regex[key] = new RegExp(key, 'g');
}

textnodes = document.evaluate(
    "//text()",
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);
for (var i = 0; i < textnodes.snapshotLength; i++) {
    node = textnodes.snapshotItem(i);
    s = node.data;
    for (key in replacements) {
        s = s.replace(regex[key], replacements[key]);
    }
    node.data = s;
}]]></programlisting>
</example>
<para>The code breaks down into four steps:</para>
<orderedlist>
<listitem><para>Define a list of string replacements, mapping certain 8-bit characters to their 7-bit equivalents.</para></listitem>
<listitem><para>Get all the text nodes of the current page.</para></listitem>
<listitem><para>Loop through the list of text nodes.</para></listitem>
<listitem><para>In each text, node, for each 8-bit character, replace it with its 7-bit equivalent.</para></listitem>
</orderedlist>
<para>The first step is really two steps.  Javascript's string replacement is based on regular expressions.  So in order to replace 8-bit characters with 7-bit equivalents, I really need to create a set of regular expression objects.</para>
<informalexample>
<programlisting><![CDATA[replacements = {
    "\xa0": " ",
    "\xa9": "(c)",
    "\xae": "(r)",
    "\xb7": "*",
    "\u2018": "'",
    "\u2019": "'",
    "\u201c": '"',
    "\u201d": '"',
    "\u2026": "...",
    "\u2002": " ",
    "\u2003": " ",
    "\u2009": " ",
    "\u2013": "-",
    "\u2014": "--",
    "\u2122": "(tm)"};
regex = {};
for (key in replacements) {
    regex[key] = new RegExp(key, 'g');
}]]></programlisting>
<para>I use the curly braces syntax to quickly create an associative array.  This is equivalent to (but less typing than) assigning each key-value pair individually:</para>
<programlisting><![CDATA[replacements["\xa0"] = " ";
replacements["\xa9"] = "(c)";
replacements["\xae"] = "(r)";
// and so forth]]></programlisting>
<para>The individual 8-bit characters are represented by their hexadecimal values, using the escaping syntax <literal>"\xa0"</literal> or <literal>"\u2018"</literal>.  Once we have an associative array of characters to strings, I loop through the array and create a list of regular expression objects.  Each regular expression object will search globally for one 8-bit character.  (The <parameter>'g'</parameter> in the second argument means search globally; otherwise each regular expression would only search and replace the first occurrence of a particular 8-bit character, and I might end up missing some.)</para>
</informalexample>
<para>The next step is to get a list of all the text nodes in the current document.  You might be tempted to say to yourself, <quote>Hey, I could just use <property>document.body.innerHTML</property> and get the whole page as a single string, and search and replace in that.</quote></para>
<informalexample>
<programlisting><![CDATA[var tmp = document.body.innerHTML;
// do a bunch of search/replace on tmp
document.body.innerHTML = tmp;]]></programlisting>
</informalexample>
<para>But this is a bad habit to get into, because the <property>innerHTML</property> property will return the entire source of the page: all the markup, all the script, all the attributes, everything.  In this case it probably wouldn't cause a problem (&html; tags themselves do not contain 8-bit characters), but in other cases it could be disastrous, and very difficult to debug.  You need to ask yourself what exactly you are trying to search-and-replace.  If the answer is <quote>the raw page source,</quote> then go ahead and use <property>innerHTML</property>.  However, in this case, the answer is <quote>all the text on the page,</quote> so the correct solution is to use an XPath query to get all the text nodes.</para>
<informalexample>
<programlisting><![CDATA[textnodes = document.evaluate(
    "//text()",
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);]]></programlisting>
<para>This works by using an XPath function, <function>text()</function>, which matches any text node.  You're probably more familiar with querying for element nodes: a list of all the <sgmltag>&lt;a&gt;</sgmltag> elements, or all the <sgmltag>&lt;img&gt;</sgmltag> elements that have an <sgmltag class="attribute">alt</sgmltag> attribute.  But the DOM also contains nodes for the actual text content within elements.  (There are other types of nodes too, like comments and processing instructions.)  And it's the text nodes that we're interested in at the moment.</para>
</informalexample>
<para>Step 3 is to loop through all the text nodes.  This is exactly the same as looping through all the elements returned from an XPath query like <literal>//a[@href]</literal>; the only difference is that each item in the loop is a text node, not an element node.</para>
<informalexample>
<programlisting><![CDATA[for (var i = 0; i < textnodes.snapshotLength; i++) {
    node = textnodes.snapshotItem(i);
    s = node.data;
    // do replacements
    node.data = s;]]></programlisting>
<para><varname>node</varname> is the current text node in the loop, and <varname>s</varname> is a string that is the actual text of <varname>node</varname>.  I'm going to use <varname>s</varname> to do the replacements, then copy the result back to the original node.</para>
</informalexample>
<para>So now that I have the text of a single node, I need to actually do the replacements.  Since I pre-created a list of regular expressions and a list of replacement string, this is relatively straightforward.</para>
<informalexample>
<programlisting><![CDATA[    for (key in replacements) {
        s = s.replace(regex[key], replacements[key]);
    }]]></programlisting>
</informalexample>
<itemizedlist role="download">
<title>Download</title>
<listitem><para><ulink url="&url_example_dumbquotes;"><filename>dumbquotes.user.js</filename></ulink></para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="pattern.certainattribute"/></para></listitem>
</itemizedlist>
</section> <!-- casestudy.dumbquotes -->

<section id="casestudy.frownies">
<?dbhtml filename="casestudy/frownies.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Frownies came to be in response to a joke.  Someone on the <ulink url="&url_greasemonkeymailinglist;">Greasemonkey mailing list</ulink> announced that they had developed a user script to convert &ascii; <quote>smilies</quote> like <literal>:-)</literal> to their graphical equivalents.  Someone else responded, wondering how long it would take for someone to do the reverse: convert graphical smilies back to text.</para>
</abstract>
</sectioninfo>
<title>Case study: Frownies</title>
<subtitle>Converting graphical smilies to text</subtitle>
<para>For the record, it took me about 20 minutes.  Most of the time was spent researching publishing software that auto-generated graphical smilies, and compiling a comprehensive list of variations.</para>
<para>This script relies on the fact that most publishing software that generates graphical smilies puts the text equivalent in the <sgmltag class="attribute">alt</sgmltag> attribute of the <sgmltag>&lt;img&gt;</sgmltag> element.  So really what this script does is replace images with their ALT text, if the ALT text matches one of a list of pre-defined constants.</para>
<example id="example.casestudy.frownies">
<title><ulink url="&url_example_frownies;" type="Download Frownies"><filename>frownies.user.js</filename></ulink></title>
<programlisting><![CDATA[// ==UserScript==
// @name          Frownies
// @namespace     http://diveintogreasemonkey.org/download/
// @description   convert graphical smilies to their text equivalents
// @include       *
// ==/UserScript==

var smilies, images, img, replacement;
smilies = [":)", ":-)" ":-(", ":(", ";-)", ";)", ":-D", ":D", ":-/",
    ":/", ":X", ":-X", ":\">", ":P", ":-P", ":O", ":-O", "X-(",
    "X(", ":->", ":>", "B-)", "B)", ">:)", ":((", ":(((", ":-((",
    ":))", ":-))", ":-|", ":|", "O:-)", "O:)", ":-B", ":B", "=;",
    "I)", "I-)", "|-)", "|)", ":-&", ":&", ":-$", ":$", "[-(", ":O)",
    ":@)", "3:-O", ":(|)", "@};-", "**==", "(~~)", "*-:)", "8-X",
    "8X", "=:)", "<):)", ";;)", ":*", ":-*", ":S", ":-S", "/:)",
    "/:-)", "8-|", "8|", "8-}", "8}", "(:|", "=P~", ":-?", ":?",
    "#-O", "#O", "=D>", "~:>", "%%-", "~O)", ":-L", ":L", "[-O<",
    "[O<", "@-)", "@)", "$-)", "$)", ">-)", ":-\"", ":^O", "B-(",
    "B(", ":)>-", "[-X", "[X", "\\:D/", ">:D<", "(%)", "=((", "#:-S",
    "#:S", "=))", "L-)", "L)", "<:-P", "<:P", ":-SS", ":SS", ":-W",
    ":W", ":-<", ":<", ">:P", ">:-P", ">:/", ";))", ":-@", "^:)^",
    ":-J", "(*)", ":GRIN:", ":-)", ":SMILE:", ":SAD:", ":EEK:",
    ":SHOCK:", ":???:", "8)", "8-)", ":COOL:", ":LOL:", ":MAD:",
    ":RAZZ:", ":OOPS:", ":CRY:", ":EVIL:", ":TWISTED:", ":ROLL:",
    ":WINK:", ":!:", ":?:", ":IDEA:", ":ARROW:", ":NEUTRAL:",
    ":MRGREEN:"];
images = document.evaluate(
    '//img[@alt]',
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);
for (var i = 0; i < images.snapshotLength; i++) {
    img = images.snapshotItem(i);
    alt = img.alt.toUpperCase();
    for (var j in smilies) {
        if (alt == smilies[j]) {
            replacement = document.createTextNode(alt);
            img.parentNode.replaceChild(replacement, img);
        }
    }
}]]></programlisting>
</example>
<para>The code breaks down into four steps:</para>
<orderedlist>
<listitem><para>Define a list of smilies (as text strings).</para></listitem>
<listitem><para>Find all the images on the page that contain an <sgmltag class="attribute">alt</sgmltag> attribute.</para></listitem>
<listitem><para>For each image, check whether the ALT text matches any of the list of &ascii; smilies.</para></listitem>
<listitem><para>If it matches, replace the <sgmltag>&lt;img&gt;</sgmltag> element with a text node that contains only the &ascii; smily.</para></listitem>
</orderedlist>
<para>The first step simply defines a list, using Javascript's <literal>[ ]</literal> syntax.</para>
<informalexample>
<programlisting><![CDATA[smilies = [":)", ":-)" ":-(", ":(", ";-)", ";)", ":-D", ":D", ":-/",
    ":/", ":X", ":-X", ":\">", ":P", ":-P", ":O", ":-O", "X-(",
    "X(", ":->", ":>", "B-)", "B)", ">:)", ":((", ":(((", ":-((",
    ":))", ":-))", ":-|", ":|", "O:-)", "O:)", ":-B", ":B", "=;",
    "I)", "I-)", "|-)", "|)", ":-&", ":&", ":-$", ":$", "[-(", ":O)",
    ":@)", "3:-O", ":(|)", "@};-", "**==", "(~~)", "*-:)", "8-X",
    "8X", "=:)", "<):)", ";;)", ":*", ":-*", ":S", ":-S", "/:)",
    "/:-)", "8-|", "8|", "8-}", "8}", "(:|", "=P~", ":-?", ":?",
    "#-O", "#O", "=D>", "~:>", "%%-", "~O)", ":-L", ":L", "[-O<",
    "[O<", "@-)", "@)", "$-)", "$)", ">-)", ":-\"", ":^O", "B-(",
    "B(", ":)>-", "[-X", "[X", "\\:D/", ">:D<", "(%)", "=((", "#:-S",
    "#:S", "=))", "L-)", "L)", "<:-P", "<:P", ":-SS", ":SS", ":-W",
    ":W", ":-<", ":<", ">:P", ">:-P", ">:/", ";))", ":-@", "^:)^",
    ":-J", "(*)", ":GRIN:", ":-)", ":SMILE:", ":SAD:", ":EEK:",
    ":SHOCK:", ":???:", "8)", "8-)", ":COOL:", ":LOL:", ":MAD:",
    ":RAZZ:", ":OOPS:", ":CRY:", ":EVIL:", ":TWISTED:", ":ROLL:",
    ":WINK:", ":!:", ":?:", ":IDEA:", ":ARROW:", ":NEUTRAL:",
    ":MRGREEN:"];]]></programlisting>
</informalexample>
<para>Next I search the page for all <sgmltag>&lt;img&gt;</sgmltag> elements with an <sgmltag class="attribute">alt</sgmltag> attribute, using an XPath query.  See <xref linkend="pattern.certainattribute"/> for more details on XPath queries.</para>
<informalexample>
<programlisting><![CDATA[images = document.evaluate(
    '//img[@alt]',
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);]]></programlisting>
</informalexample>
<para>Step 3 loops through all these <sgmltag>&lt;img&gt;</sgmltag> elements, and checks whether the <sgmltag class="attribute">alt</sgmltag> attribute matches any of my defined smilies.  Because some smilies contain letters, I use the <methodname>toUpperCase()</methodname> method to convert the <sgmltag class="attribute">alt</sgmltag> attribute to uppercase before comparing.</para>
<informalexample>
<programlisting><![CDATA[for (var i = 0; i < images.snapshotLength; i++) {
    img = images.snapshotItem(i);
    alt = img.alt.toUpperCase())
    for (var j in smilies) {
        if (alt == smilies[j]) {
            // ...
        }
    }
}]]></programlisting>
</informalexample>
<para>Finally, I create a new text node with the text of the smily, and replace the existing <sgmltag>&lt;img&gt;</sgmltag> element.  See <xref linkend="pattern.replaceelement"/> for more details.</para>
<informalexample>
<programlisting><![CDATA[            replacement = document.createTextNode(alt);
            img.parentNode.replaceChild(replacement, img);]]></programlisting>
</informalexample>
<itemizedlist role="download">
<title>Download</title>
<listitem><para><ulink url="&url_example_frownies;"><filename>frownies.user.js</filename></ulink></para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="pattern.certainattribute"/></para></listitem>
<listitem><para><xref linkend="pattern.replaceelement"/></para></listitem>
</itemizedlist>
</section> <!-- casestudy.frownies -->

<section id="casestudy.zoomtextarea">
<?dbhtml filename="casestudy/zoomtextarea.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Zoom Textarea alters web forms to add a toolbar above every <sgmltag>&lt;textarea&gt;</sgmltag> element (used for entering multiple lines of text).  The toolbar lets you increase or decrease the text size of the <sgmltag>&lt;textarea&gt;</sgmltag>, without changing the style of the rest of the page.  The buttons are fully keyboard-accessible; you can tab to them and press <userinput><keycap>ENTER</keycap></userinput> instead of clicking them with your mouse.  (I mention this up front because accessibility matters, and also because it was harder than it sounds.)</para>
</abstract>
</sectioninfo>
<title>Case study: Zoom Textarea</title>
<subtitle>Adding buttons to zoom textareas</subtitle>
<example id="example.casestudy.zoomtextarea">
<title><ulink url="&url_example_zoomtextarea;" type="Download Zoom Textarea"><filename>zoomtextarea.user.js</filename></ulink></title>
<programlisting><![CDATA[// ==UserScript==
// @name          Zoom Textarea
// @namespace     http://diveintogreasemonkey.org/download/
// @description   add controls to zoom textareas
// @include       *
// ==/UserScript==

var textareas, textarea;

textareas = document.getElementsByTagName('textarea');
if (!textareas.length) { return; }

function textarea_zoom_in(event) {
    var link, textarea, s;
    link = event.currentTarget;
    textarea = link._target;
    s = getComputedStyle(textarea, "");
    textarea.style.width = (parseFloat(s.width) * 1.5) + "px";
    textarea.style.height = (parseFloat(s.height) * 1.5) + "px";
    textarea.style.fontSize = (parseFloat(s.fontSize) + 7.0) + 'px';
    event.preventDefault();
}

function textarea_zoom_out(event) {
    var link, textarea, s;
    link = event.currentTarget;
    textarea = link._target;
    s = getComputedStyle(textarea, "");
    textarea.style.width = (parseFloat(s.width) * 2.0 / 3.0) + "px";
    textarea.style.height = (parseFloat(s.height) * 2.0 / 3.0) + "px";
    textarea.style.fontSize = (parseFloat(s.fontSize) - 7.0) + "px";
    event.preventDefault();
}

function createButton(target, func, title, width, height, src) {
    var img, button;
    img = document.createElement('img');
    img.width = width;
    img.height = height;
    img.style.borderTop = img.style.borderLeft = "1px solid #ccc";
    img.style.borderRight = img.style.borderBottom = "1px solid #888";
    img.style.marginRight = "2px";
    img.src = src;
    button = document.createElement('a');
    button._target = target;
    button.title = title;
    button.href = '#';
    button.onclick = func;
    button.appendChild(img);
    return button;
}

for (var i = 0; i < textareas.length; i++) {
    textarea = textareas[i];
    textarea.parentNode.insertBefore(
        createButton(
            textarea,
            textarea_zoom_in,
            'Increase textarea size',
            20,
            20,
            'data:image/gif;base64,'+
'R0lGODlhFAAUAOYAANPS1tva3uTj52NjY2JiY7KxtPf3%2BLOys6WkpmJiYvDw8fX19vb'+
'296Wlpre3uEZFR%2B%2Fv8aqpq9va3a6tr6Kho%2Bjo6bKytZqZml5eYMLBxNra21JSU3'+
'Jxc3RzdXl4emJhZOvq7KamppGQkr29vba2uGBgYdLR1dLS0lBPUVRTVYB%2Fgvj4%2BYK'+
'Bg6SjptrZ3cPDxb69wG1tbsXFxsrJy29vccDAwfT09VJRU6uqrFlZW6moqo2Mj4yLjLKy'+
's%2Fj4%2BK%2Busu7t783Nz3l4e19fX7u6vaalqNPS1MjHylZVV318ftfW2UhHSG9uccv'+
'KzfHw8qqqrNPS1eXk5tvb3K%2BvsHNydeLi40pKS2JhY2hnalpZWlVVVtDQ0URDRJmZm5'+
'mYm11dXp2cnm9vcFxcXaOjo0pJSsC%2FwuXk6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'+
'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC'+
'H5BAAAAAAALAAAAAAUABQAAAeagGaCg4SFhoeIiYqKTSQUFwgwi4JlB0pOCkEiRQKKRxM'+
'gKwMGDFEqBYpPRj4GAwwLCkQsijwQBAQJCUNSW1mKSUALNiVVJzIvSIo7GRUaGzUOPTpC'+
'igUeMyNTIWMHGC2KAl5hCBENYDlcWC7gOB1LDzRdWlZMAZOEJl83VPb3ggAfUnDo5w%2F'+
'AFRQxJPj7J4aMhYWCoPyASFFRIAA7'),
        textarea);
    textarea.parentNode.insertBefore(
        createButton(
            textarea,
            textarea_zoom_out,
            'Decrease textarea size',
            20,
            20,
            'data:image/gif;base64,'+
'R0lGODlhFAAUAOYAANPS1uTj59va3vDw8bKxtGJiYrOys6Wkpvj4%2BPb29%2FX19mJiY'+
'%2Ff3%2BKqqrLe3uLKytURDRFpZWqmoqllZW9va3aOjo6Kho4KBg729vWJhZK%2BuskZF'+
'R4B%2FgsLBxHNydY2Mj%2Ff396amptLS0l9fX9fW2dDQ0W1tbpmZm8DAwfT09fHw8n18f'+
'uLi49LR1V5eYOjo6VBPUa6tr769wEhHSNra20pJStPS1KuqrNPS1ZmYm%2B7t77Kys8rJ'+
'y%2Fj4%2BaSjpm9uca%2BvsMjHyqalqHRzdVJRU8PDxVRTVcvKzc3Nz0pKS9rZ3evq7MC'+
'%2FwsXFxp2cnnl4e1VVVu%2Fv8ba2uM7Oz29vcbu6vZqZmnJxc9vb3PHx8uXk5mhnamJh'+
'Y1xcXZGQklZVV29vcHl4eoyLjKqpq6Wlpl1dXuXk6AAAAAAAAAAAAAAAAAAAAAAAAAAAA'+
'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'+
'AAACH5BAAAAAAALAAAAAAUABQAAAeZgGaCg4SFhoeIiYqKR1IWVgcyi4JMBiQqA0heQgG'+
'KQTFLPQgMCVocBIoNNqMgCQoDVReKYlELCwUFI1glEYorOgopWSwiTUVfih8dLzRTKA47'+
'Ek%2BKBGE8GEAhFQYuPooBOWAHY2ROExBbSt83QzMbVCdQST8Ck4QtZUQe9faCABlGrvD'+
'rB4ALDBMU%2BvnrUuOBQkE4NDycqCgQADs%3D'),
        textarea);
    textarea.parentNode.insertBefore(
        document.createElement('br'),
        textarea);
}]]></programlisting>
</example>
<para>The code looks complicated, and it is complicated, but for different reasons.  It looks complicated because of the large multiline jibberish-looking strings in the middle of it.  Those are <link linkend="pattern.addimage"><systemitem>data:</systemitem> &uri;s</link>, which look like hell but are easy to generate.  The real complexity lies elsewhere.</para>
<para>First, I get a list of all the <sgmltag>&lt;textarea&gt;</sgmltag> elements on the page.  See <xref linkend="pattern.oneelement"/> for more details on this pattern.  If there aren't any, there's no point continuing, so <constant>return</constant>.</para>
<informalexample>
<programlisting><![CDATA[textareas = document.getElementsByTagName('textarea');
if (!textareas.length) { return; }]]></programlisting>
</informalexample>
<para>Now let's skip around a little.  Our <quote>toolbar</quote> is visually a row of buttons, but each button is really just an image of something that looks pushable, wrapped in a link that executes one of our Javascript functions.</para>
<para>Since we'll be creating more than one button (this script only has two, but you could easily extend it with more functionality), I created a function to encapsulate all the button-making logic.</para>
<informalexample>
<programlisting><![CDATA[function createButton(target, func, title, width, height, src) {]]></programlisting>
<para>The <function>createButton</function> function takes 6 arguments:</para>
<variablelist>
<varlistentry>
<term><parameter>target</parameter></term>
<listitem><para>an element object, the <sgmltag>&lt;textarea&gt;</sgmltag> element that this button will control</para></listitem>
</varlistentry>
<varlistentry>
<term><parameter>func</parameter></term>
<listitem><para>a function object, the Javascript function to be called when the user clicks the button with the mouse or activates it with the keyboard</para></listitem>
</varlistentry>
<varlistentry>
<term><parameter>title</parameter></term>
<listitem><para>a string, the text of the tooltip when the user moves their cursor over the button</para></listitem>
</varlistentry>
<varlistentry>
<term><parameter>width</parameter></term>
<listitem><para>an integer, the width of the button.  This should be the width of the graphic given in the <parameter>src</parameter> argument.</para></listitem>
</varlistentry>
<varlistentry>
<term><parameter>height</parameter></term>
<listitem><para>an integer, the height of the button.  This should be the height of the graphic given in the <parameter>src</parameter> argument.</para></listitem>
</varlistentry>
<varlistentry>
<term><parameter>src</parameter></term>
<listitem><para>a string, the &url;, path, or <systemitem>data:</systemitem> &uri; of the button graphic</para></listitem>
</varlistentry>
</variablelist>
</informalexample>
<para>Creating a button is split into two halves: creating the <sgmltag>&lt;img&gt;</sgmltag> element, and then creating the <sgmltag>&lt;a&gt;</sgmltag> element around it.</para>
<para>I create the <sgmltag>&lt;img&gt;</sgmltag> element by calling <function>document.createElement</function> and setting a few attributes, including style attributes.  See <xref linkend="pattern.setstyle"/> for more details on this pattern.</para>
<informalexample>
<programlisting><![CDATA[    img = document.createElement('img');
    img._target = target;
    img.width = width;
    img.height = height;
    img.style.borderTop = img.style.borderLeft = "1px solid #ccc";
    img.style.borderRight = img.style.borderBottom = "1px solid #888";
    img.style.marginRight = "2px";
    img.src = src;]]></programlisting>
</informalexample>
<para>One  thing I just want to point out quickly, because I think it's cool.  You can assign the same value to two attributes at once by using this syntax:</para>
<informalexample>
<programlisting><![CDATA[    img.style.borderTop = img.style.borderLeft = "1px solid #ccc";]]></programlisting>
</informalexample>
<para>OK, moving on.  The second half of creating a button is creating the link (an <sgmltag>&lt;a&gt;</sgmltag> element) and putting the <sgmltag>&lt;img&gt;</sgmltag> element inside it.</para>
<informalexample>
<programlisting><![CDATA[    button = document.createElement('a');
    button._target = target;
    button.title = title;
    button.href = '#';
    button.onclick = func;
    button.appendChild(img);]]></programlisting>
</informalexample>
<para>There are two things I want to point out here.  First, I need to assign a bogus <property>href</property> attribute to the link, otherwise Firefox would treat it a named anchor and wouldn't add it to the tab index (i.e. you wouldn't be able to tab to it, making it inaccessible with the keyboard).  Second, I'm setting the <property>_target</property> attribute to store a reference to the target <sgmltag>&lt;textarea&gt;</sgmltag>.  This is perfectly legal in Javascript; you can create new attributes on an object just by assigning them a value.  I'll access the custom <property>_target</property> attribute later, in the <systemitem>onclick</systemitem> event handler.</para>
<para>Now let's jump back to the <systemitem>onclick</systemitem> handler itself.  Each handler is a function that takes one parameter, <parameter>event</parameter>.</para>
<informalexample>
<programlisting><![CDATA[function textarea_zoom_in(event)]]></programlisting>
</informalexample>
<para>The <varname>event</varname> object has several properties, only one of which I'm interested in at the moment: <property>currentTarget</property>.</para>
<informalexample>
<programlisting><![CDATA[    link = event.currentTarget;]]></programlisting>
</informalexample>
<para>If you read <ulink url="&url_event_docs;">the documentation on the <classname>Event</classname> object</ulink>, you'll see that there are several target-related properties, including one simply called <property>target</property>.  You might be tempted to use <property>event.target</property> to get a reference to the clicked link, but it behaves (in my opinion) inconsistently.  When the user tabs to the button and hits <userinput><keycap>ENTER</keycap></userinput>, <property>event.target</property> is the link, but when the user clicks the button with the mouse, <property>event.target</property> is the image inside the link!  I'm sure there's a reasonable explanation for this, but it is beyond my level of understanding of the DOM event model.  In any case, <property>event.currentTarget</property> returns the link in all cases, so I use that.</para>
<para>Next I retrieve the reference to the <sgmltag>&lt;textarea&gt;</sgmltag> I'm actually going to be zooming, via the custom <property>_target</property> property that I set when I created the button.</para>
<informalexample>
<programlisting><![CDATA[    textarea = link._target;]]></programlisting>
</informalexample>
<para>Now the real fun begins.  (And you thought you were having fun already!)  I need to get the current dimensions and font size of the <sgmltag>&lt;textarea&gt;</sgmltag>, so that I can make them bigger.  Simply retrieving the appropriate attributes from <property>textarea.style</property> (<property>textarea.style.width</property>, <property>textarea.style.height</property>, and <property>textarea.style.fontSize</property>) will <emphasis>not</emphasis> work, because those only get set if the page actually defined them in a <sgmltag class="attribute">style</sgmltag> attribute on the <sgmltag>&lt;textarea&gt;</sgmltag> itself.  That's not what I want; I want the actual current style.  For that I need <function>getComputedStyle</function>.  See <xref linkend="pattern.getcomputedstyle"/> for more details on this function.</para>
<informalexample>
<programlisting><![CDATA[    s = getComputedStyle(textarea, "");
    textarea.style.width = (parseFloat(s.width) * 1.5) + "px";
    textarea.style.height = (parseFloat(s.height) * 1.5) + "px";
    textarea.style.fontSize = (parseFloat(s.fontSize) + 7.0) + 'px';]]></programlisting>
</informalexample>
<para>Finally, do you remember that bogus <property>href</property> value I added to my button link to make sure it was keyboard-accessible?  Well, it's now become an annoyance, because after Firefox finishes executing the <systemitem>onclick</systemitem> handler, it's going to try to follow that link.  Since it points to a non-existent anchor, Firefox is going to jump to the top of the page, regardless of where the button is.  This is annoying, and to stop it, I need to call <methodname>event.preventDefault()</methodname> before finishing my <systemitem>onclick</systemitem> handler.</para>
<informalexample>
<programlisting><![CDATA[    event.preventDefault();]]></programlisting>
</informalexample>
<para>The rest of the script is straightforward.  I loop through all the <sgmltag>&lt;textarea&gt;</sgmltag> elements, create zoom buttons for each of them (each with its own <systemitem>onclick</systemitem> handler and button graphic), and insert the zoom buttons before the <sgmltag>&lt;textarea&gt;</sgmltag>.  For each image, I use a <systemitem>data:</systemitem> &uri; to create an inline graphic, so users don't need to hit a central server to get the button graphics.  See <xref linkend="pattern.insertbefore"/> and <xref linkend="pattern.addimage"/> for more details on these patterns.</para>
<informalexample>
<programlisting><![CDATA[for (var i = 0; i < textareas.length; i++) {
    textarea = textareas[i];
    textarea.parentNode.insertBefore(
        createButton(
            textarea,
            textarea_zoom_in,
            'Increase textarea size',
            20,
            20,
            'data:image/gif;base64,'+
'R0lGODlhFAAUAOYAANPS1tva3uTj52NjY2JiY7KxtPf3%2BLOys6WkpmJiYvDw8fX19vb'+
'296Wlpre3uEZFR%2B%2Fv8aqpq9va3a6tr6Kho%2Bjo6bKytZqZml5eYMLBxNra21JSU3'+
'Jxc3RzdXl4emJhZOvq7KamppGQkr29vba2uGBgYdLR1dLS0lBPUVRTVYB%2Fgvj4%2BYK'+
'Bg6SjptrZ3cPDxb69wG1tbsXFxsrJy29vccDAwfT09VJRU6uqrFlZW6moqo2Mj4yLjLKy'+
's%2Fj4%2BK%2Busu7t783Nz3l4e19fX7u6vaalqNPS1MjHylZVV318ftfW2UhHSG9uccv'+
'KzfHw8qqqrNPS1eXk5tvb3K%2BvsHNydeLi40pKS2JhY2hnalpZWlVVVtDQ0URDRJmZm5'+
'mYm11dXp2cnm9vcFxcXaOjo0pJSsC%2FwuXk6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'+
'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC'+
'H5BAAAAAAALAAAAAAUABQAAAeagGaCg4SFhoeIiYqKTSQUFwgwi4JlB0pOCkEiRQKKRxM'+
'gKwMGDFEqBYpPRj4GAwwLCkQsijwQBAQJCUNSW1mKSUALNiVVJzIvSIo7GRUaGzUOPTpC'+
'igUeMyNTIWMHGC2KAl5hCBENYDlcWC7gOB1LDzRdWlZMAZOEJl83VPb3ggAfUnDo5w%2F'+
'AFRQxJPj7J4aMhYWCoPyASFFRIAA7'),
        textarea);
    textarea.parentNode.insertBefore(
        createButton(
            textarea,
            textarea_zoom_out,
            'Decrease textarea size',
            20,
            20,
            'data:image/gif;base64,'+
'R0lGODlhFAAUAOYAANPS1uTj59va3vDw8bKxtGJiYrOys6Wkpvj4%2BPb29%2FX19mJiY'+
'%2Ff3%2BKqqrLe3uLKytURDRFpZWqmoqllZW9va3aOjo6Kho4KBg729vWJhZK%2BuskZF'+
'R4B%2FgsLBxHNydY2Mj%2Ff396amptLS0l9fX9fW2dDQ0W1tbpmZm8DAwfT09fHw8n18f'+
'uLi49LR1V5eYOjo6VBPUa6tr769wEhHSNra20pJStPS1KuqrNPS1ZmYm%2B7t77Kys8rJ'+
'y%2Fj4%2BaSjpm9uca%2BvsMjHyqalqHRzdVJRU8PDxVRTVcvKzc3Nz0pKS9rZ3evq7MC'+
'%2FwsXFxp2cnnl4e1VVVu%2Fv8ba2uM7Oz29vcbu6vZqZmnJxc9vb3PHx8uXk5mhnamJh'+
'Y1xcXZGQklZVV29vcHl4eoyLjKqpq6Wlpl1dXuXk6AAAAAAAAAAAAAAAAAAAAAAAAAAAA'+
'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'+
'AAACH5BAAAAAAALAAAAAAUABQAAAeZgGaCg4SFhoeIiYqKR1IWVgcyi4JMBiQqA0heQgG'+
'KQTFLPQgMCVocBIoNNqMgCQoDVReKYlELCwUFI1glEYorOgopWSwiTUVfih8dLzRTKA47'+
'Ek%2BKBGE8GEAhFQYuPooBOWAHY2ROExBbSt83QzMbVCdQST8Ck4QtZUQe9faCABlGrvD'+
'rB4ALDBMU%2BvnrUuOBQkE4NDycqCgQADs%3D'),
        textarea);
    textarea.parentNode.insertBefore(
        document.createElement('br'),
        textarea);
}]]></programlisting>
</informalexample>
<itemizedlist role="download">
<title>Download</title>
<listitem><para><ulink url="&url_example_zoomtextarea;"><filename>zoomtextarea.user.js</filename></ulink></para></listitem>
</itemizedlist>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_event_docs;"><classname>Event</classname> documentation</ulink></para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="pattern.oneelement"/></para></listitem>
<listitem><para><xref linkend="pattern.getcomputedstyle"/></para></listitem>
<listitem><para><xref linkend="pattern.setstyle"/></para></listitem>
<listitem><para><xref linkend="pattern.insertbefore"/></para></listitem>
<listitem><para><xref linkend="pattern.addimage"/></para></listitem>
</itemizedlist>
</section> <!-- casestudy.zoomtextarea -->

<section id="casestudy.accessbar">
<?dbhtml filename="casestudy/accessbar.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Access Bar displays accesskeys defined on a web page.  Accesskeys are an accessibility feature that allow you to jump to a specific link or form field with a keyboard shortcut defined by the page author.  (<ulink url="&url_diveintoaccesskeys;">Learn more about accesskeys</ulink>.)</para>
</abstract>
</sectioninfo>
<title>Case study: Access Bar</title>
<subtitle>Displaying accesskeys in a fixed status bar</subtitle>
<para>Firefox supports accesskeys, but it does not display which keys are defined on a page.  Thus, Access Bar was born.</para>
<example id="example.casestudy.accessbar">
<title><ulink url="&url_example_accessbar;" type="Download Access Bar"><filename>accessbar.user.js</filename></ulink></title>
<programlisting><![CDATA[// ==UserScript==
// @name          Access Bar
// @namespace     http://diveintogreasemonkey.org/download/
// @description   show accesskeys defined on page
// @include       *
// ==/UserScript==

function addGlobalStyle(css) {
    var head, style;
    head = document.getElementsByTagName('head')[0];
    if (!head) { return; }
    style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = css;
    head.appendChild(style);
}

var akeys, descriptions, a, desc, label, div;
akeys = document.evaluate(
    "//*[@accesskey]",
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);
if (!akeys.snapshotLength) { return; }
descriptions = new Array();
desc = '';
for (var i = 0; i < akeys.snapshotLength; i++) {
    a = akeys.snapshotItem(i);
    desctext = '';
    if (a.nodeName == 'INPUT') {
        label = document.evaluate("//label[@for='" + a.name + "']",
            document,
            null,
            XPathResult.FIRST_ORDERED_NODE_TYPE,
            null).singleNodeValue;
        if (label) {
            desctext = label.title;
            if (!desctext) { desctext = label.textContent; }
        }
    }
    if (!desctext) { desctext = a.textContent; }
    if (!desctext) { desctext = a.title; }
    if (!desctext) { desctext = a.name; }
    if (!desctext) { desctext = a.id; }
    if (!desctext) { desctext = a.href; }
    if (!desctext) { desctext = a.value; }
    desc = '<strong>[' +
        a.getAttribute('accesskey').toUpperCase() + ']</strong> ';
    if (a.href) {
        desc += '<a href="' + a.href + '">' + desctext + '</a>';
    } else {
        desc += desctext;
    }
    descriptions.push(desc);
}
descriptions.sort();
div = document.createElement('div');
div.id = 'accessbar-div-0';
desc = '<div><ul><li class="first">' + descriptions[0] + '</li>';
for (var i = 1; i < descriptions.length; i++) {
    desc = desc + '<li>' + descriptions[i] + '</li>';
}
desc = desc + '</ul></div>';
div.innerHTML = desc;
document.body.style.paddingBottom = "4em";
window.addEventListener(
    "load",
    function() {
        document.body.appendChild(div);
    },
    true);
addGlobalStyle(
'#accessbar-div-0 {'+
'  position: fixed;' +
'  left: 0;' +
'  right: 0;' +
'  bottom: 0;' +
'  top: auto;' +
'  border-top: 1px solid silver;' +
'  background: black;' +
'  color: white;' +
'  margin: 1em 0 0 0;' +
'  padding: 5px 0 0.4em 0;' +
'  width: 100%;' +
'  font-family: Verdana, sans-serif;' +
'  font-size: small;' +
'  line-height: 160%;' +
'}' +
'#accessbar-div-0 a,' +
'#accessbar-div-0 li,' +
'#accessbar-div-0 span,' +
'#accessbar-div-0 strong {' +
'  background-color: transparent;' +
'  color: white;' +
'}' +
'#accessbar-div-0 div {' +
'  margin: 0 1em 0 1em;' +
'}' +
'#accessbar-div-0 div ul {' +
'  margin-left: 0;' +
'  margin-bottom: 5px;' +
'  padding-left: 0;' +
'  display: inline;' +
'}' +
'#accessbar-div-0 div ul li {' +
'  margin-left: 0;' +
'  padding: 3px 15px;' +
'  border-left: 1px solid silver;' +
'  list-style: none;' +
'  display: inline;' +
'}' +
'#accessbar-div-0 div ul li.first {' +
'  border-left: none;' +
'  padding-left: 0;' +
'}');]]></programlisting>
</example>
<para>The code breaks down into six steps:</para>
<orderedlist>
<listitem><para>Define a helper function, <function>addGlobalStyle</function></para></listitem>
<listitem><para>Find all the page elements that include an <sgmltag class="attribute">accesskey</sgmltag> attribute</para></listitem>
<listitem><para>Loop through those elements and determine the most appropriate text to describe each element</para></listitem>
<listitem><para>Construct a sorted list of links to the <sgmltag class="attribute">accesskey</sgmltag>-enabled elements</para></listitem>
<listitem><para>Add the sorted list to the page, using standard <sgmltag>ul</sgmltag> and <sgmltag>li</sgmltag> elements</para></listitem>
<listitem><para>Style the list so it appears as a fixed faux-status-bar at the bottom of the viewport</para></listitem>
</orderedlist>
<para>First things first.  I need a helper function, <function>addGlobalStyle</function>, to inject my own CSS styles (used in step 6).  See <xref linkend="pattern.addcss"/> for more details on this pattern.</para>
<informalexample>
<programlisting><![CDATA[function addGlobalStyle(css) {
    var head, style;
    head = document.getElementsByTagName('head')[0];
    if (!head) { return; }
    style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = css;
    head.appendChild(style);
}]]></programlisting>
</informalexample>
<para>Step 2 gets a list of all the page elements that contain an <sgmltag class="attribute">accesskey</sgmltag> attribute.  This is easy with Firefox's XPath support.  Note that if the XPath query returns no results, I simply bail, since there will be nothing to display.  See <xref linkend="pattern.certainattribute"/> for more information on this pattern.</para>
<informalexample>
<programlisting><![CDATA[var akeys, descriptions, a, i, desc, label, div;
akeys = document.evaluate(
    "//*[@accesskey]",
    document,
    null,
    XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,
    null);
if (!akeys.snapshotLength) { return; }]]></programlisting>
</informalexample>
<para>Step 3, constructing the list of suitable descriptions for each <sgmltag class="attribute">accesskey</sgmltag>-enabled element, is the most complicated part of the script.  The problem is that <sgmltag class="attribute">accesskey</sgmltag> attributes can appear in several different &html; elements.</para>
<para>An <sgmltag>input</sgmltag> element in a form can define an <sgmltag class="attribute">accesskey</sgmltag>.  <sgmltag>input</sgmltag> elements may or may not have an associated <sgmltag>label</sgmltag> that contains an associated text label for the <sgmltag>input</sgmltag> field.  If so, the <sgmltag>label</sgmltag> may contain a <sgmltag class="attribute">title</sgmltag> attribute that gives even more detailed information about the <sgmltag>input</sgmltag> field.  Or the <sgmltag>label</sgmltag> attribute may simply contain text.  Or the <sgmltag>input</sgmltag> element may have no associated label at all, in which case the <sgmltag class="attribute">value</sgmltag> attribute of the <sgmltag>input</sgmltag> element is the best I can do.</para>
<para>On the other hand, the <sgmltag>label</sgmltag> itself can define the <sgmltag class="attribute">accesskey</sgmltag>, instead of the <sgmltag>input</sgmltag> element the label describes.  Again, I'll look for a description the <sgmltag class="attribute">title</sgmltag> attribute of the <sgmltag>label</sgmltag> element, but fall back to the text of the label if no <sgmltag class="attribute">title</sgmltag> attribute is present.</para>
<para>A link can also define an <sgmltag class="attribute">accesskey</sgmltag> attribute.  If so, the link text is the obvious choice.  But if the link has no text (for example, if it only contains an image), then the link's <sgmltag class="attribute">title</sgmltag> attribute is the next place to look.  If the link contains no text and no <sgmltag class="attribute">title</sgmltag>, I fall back to the link's <sgmltag class="attribute">name</sgmltag> attribute, and failing that, the link's <sgmltag>id</sgmltag> attribute.</para>
<para>Ain't heuristics a bitch?  Here's the full algorithm.  Remember, <varname>akeys</varname> is an <classname>XPathResult</classname> object, so I need to get each result by calling <methodname>akeys.snapshotItem(i)</methodname>.</para>
<informalexample>
<programlisting><![CDATA[descriptions = new Array();
desc = '';
for (var i = 0; i < akeys.snapshotLength; i++) {
    a = akeys.snapshotItem(i);
    desctext = '';
    if (a.nodeName == 'INPUT') {
        label = document.evaluate("//label[@for='" + a.name + "']",
            document,
            null,
            XPathResult.FIRST_ORDERED_NODE_TYPE,
            null).singleNodeValue;
        if (label) {
            desctext = label.title;
            if (!desctext) { desctext = label.textContent; }
        }
    }
    if (!desctext) { desctext = a.textContent; }
    if (!desctext) { desctext = a.title; }
    if (!desctext) { desctext = a.name; }
    if (!desctext) { desctext = a.id; }
    if (!desctext) { desctext = a.href; }
    if (!desctext) { desctext = a.value; }
    desc = '<strong>[' +
        a.getAttribute('accesskey').toUpperCase() + ']</strong> ';
    if (a.href) {
        desc += '<a href="' + a.href + '">' + desctext + '</a>';
    } else {
        desc += desctext;
    }
    descriptions.push(desc);
}]]></programlisting>
</informalexample>
<para>Step 4 is simple, since Javascript arrays have a <methodname>sort</methodname> method that sorts the array in place.</para>
<informalexample>
<programlisting><![CDATA[descriptions.sort();]]></programlisting>
</informalexample>
<para>Step 5 creates the &html; to render the list of <sgmltag class="attribute">accesskey</sgmltag>-enabled elements.  I create a wrapper <sgmltag>&lt;div&gt;</sgmltag>, construct the &html; for the list of accesskeys as a string, set the wrapper <sgmltag>&lt;div&gt;</sgmltag>'s <property>innerHTML</property> property, and finally add it to the end of the page.  Because of when user scripts are executed, complex changes to a page should be delayed until after the page is done loading, so I use <methodname>window.addEventListener</methodname> to add an &onload; event that adds the wrapper <sgmltag>&lt;div&gt;</sgmltag> to the page.</para>
<para>See <xref linkend="pattern.innerhtml"/> for more information on the use of <property>innerHTML</property>, and <xref linkend="pattern.postprocess"/> for information on the use of <methodname>window.addEventListener</methodname>.</para>
<informalexample>
<programlisting><![CDATA[div = document.createElement('div');
div.id = 'accessbar-div-0';
desc = '<div><ul><li class="first">' + descriptions[0] + '</li>';
for (var i = 1; i < descriptions.length; i++) {
    desc = desc + '<li>' + descriptions[i] + '</li>';
}
desc = desc + '</ul></div>';
div.innerHTML = desc;
document.body.style.paddingBottom = "4em";
window.addEventListener(
    "load",
    function() {
        document.body.appendChild(div);
    },
    true);]]></programlisting>
</informalexample>
<para>Finally, in step 6, I add my own set of CSS declarations to the page so that the &html; I'm injecting will look pretty.  (Specifically, it will appear as a fixed black bar along the bottom of the page, that stays in view even as you scroll the page.  This is made possible by Firefox's support for the <literal>position:fixed</literal> display type.)  See <xref linkend="pattern.addcss"/> for more information.</para>
<informalexample>
<programlisting><![CDATA[addGlobalStyle(
'#accessbar-div-0 {'+
'  position: fixed;' +
'  left: 0;' +
'  right: 0;' +
'  bottom: 0;' +
'  top: auto;' +
'  border-top: 1px solid silver;' +
'  background: black;' +
'  color: white;' +
'  margin: 1em 0 0 0;' +
'  padding: 5px 0 0.4em 0;' +
'  width: 100%;' +
'  font-family: Verdana, sans-serif;' +
'  font-size: small;' +
'  line-height: 160%;' +
'}' +
'#accessbar-div-0 a,' +
'#accessbar-div-0 li,' +
'#accessbar-div-0 span,' +
'#accessbar-div-0 strong {' +
'  background-color: transparent;' +
'  color: white;' +
'}' +
'#accessbar-div-0 div {' +
'  margin: 0 1em 0 1em;' +
'}' +
'#accessbar-div-0 div ul {' +
'  margin-left: 0;' +
'  margin-bottom: 5px;' +
'  padding-left: 0;' +
'  display: inline;' +
'}' +
'#accessbar-div-0 div ul li {' +
'  margin-left: 0;' +
'  padding: 3px 15px;' +
'  border-left: 1px solid silver;' +
'  list-style: none;' +
'  display: inline;' +
'}' +
'#accessbar-div-0 div ul li.first {' +
'  border-left: none;' +
'  padding-left: 0;' +
'}');]]></programlisting>
</informalexample>
<itemizedlist role="download">
<title>Download</title>
<listitem><para><ulink url="&url_example_accessbar;"><filename>accessbar.user.js</filename></ulink></para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="pattern.addcss"/></para></listitem>
<listitem><para><xref linkend="pattern.certainattribute"/></para></listitem>
<listitem><para><xref linkend="pattern.innerhtml"/></para></listitem>
<listitem><para><xref linkend="pattern.postprocess"/></para></listitem>
</itemizedlist>
</section> <!-- casestudy.accessbar -->

</chapter> <!-- casestudy -->

<chapter id="advanced">
<?dbhtml filename="advanced/index.html"?>
<title>Advanced Topics</title>

<section id="advanced.getvalue">
<?dbhtml filename="advanced/gm_getvalue.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Greasemonkey defines two functions, <function>GM_setValue</function> and <function>GM_getValue</function>, that allow user scripts to store and retrieve <quote>private</quote> data that only the user script can access.  (Other scripts can't access them, not even other user scripts.)  You can use these functions to store script-specific configuration, to maintain a cache that persists between pages, or to keep a permanent activity log.</para>
</abstract>
</sectioninfo>
<title>Storing and retrieving persistent data</title>
<note>
<title/>
<para>Data stored with <function>GM_setValue</function> and retrieved with <function>GM_getValue</function> are similar to browser cookies, but there are important differences.  Both are stored on the local machine, but while cookies are <emphasis>domain-specific</emphasis> and can only be accessed from their originating domain, Greasemonkey configuration values are <emphasis>script-specific</emphasis> and can only be accessed by the user script that created them (regardless of the &url; that the user script is currently running on).  And unlike cookies, user script data are never transmitted to remote servers.</para>
</note>
<para><function>GM_setValue</function> stores a script-specific configuration value, and <function>GM_getValue</function> retrieves it.</para>
<informalexample>
<programlisting><![CDATA[function GM_setValue(key, value);

function GM_getValue(key, defaultValue);]]></programlisting>
</informalexample>
<para><parameter>key</parameter> argument is a string of no fixed format.  <parameter>value</parameter> may be a string, boolean, or integer.  The <parameter>defaultValue</parameter> argument of <function>GM_getValue</function> is optional; if present, it will be returned if the requested <parameter>key</parameter> does not exist.  If no <parameter>defaultValue</parameter> is given and the requested <parameter>key</parameter> does not exist, <function>GM_getValue</function> will return <returnvalue>undefined</returnvalue>.</para>
<para>These functions were introduced in Greasemonkey 0.3.  You should <link linkend="pattern.test">test whether they exist</link> and degrade gracefully if they do not.</para>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_mypipstag;">MyPIPsTag</ulink> prompts you for a username the first time you run it.</para></listitem>
<listitem><para><ulink url="&url_post_interceptor;">POST Interceptor</ulink> adds menu items (with <link linkend="advanced.registermenucommand"><function>GM_registerMenuCommand</function></link>) to toggle whether the script is active.</para></listitem>
<listitem><para><ulink url="&url_msdn_language_filter;">&msdn; Language Filter</ulink> inserts its configuration options into the page itself.</para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="api.gmgetvalue"/></para></listitem>
<listitem><para><xref linkend="api.gmsetvalue"/></para></listitem>
</itemizedlist>
</section> <!-- advanced.getvalue -->

<section id="advanced.registermenucommand">
<?dbhtml filename="advanced/gm_registermenucommand.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Greasemonkey defines a function, <function>GM_registerMenuCommand</function>, that allows user scripts to add menu items to the Firefox menu bar.  Registered menu items appear in the <menuchoice><guimenuitem>User Script <accel>C</accel>ommands</guimenuitem></menuchoice> submenu when the user script is active.</para>
</abstract>
</sectioninfo>
<title>Adding items to the menubar</title>
<informalexample>
<programlisting><![CDATA[function GM_registerMenuCommand(menuText, callbackFunction);]]></programlisting>
</informalexample>
<para><parameter>menuText</parameter> is a string, the text of the menu item to add.  <parameter>callbackFunction</parameter> is a function object.  When the menu item is selected, the <function>callbackFunction</function> function is called.</para>
<para>This function was introduced in Greasemonkey 0.2.6.  You should <link linkend="pattern.test">test whether it exists</link> and degrade gracefully if it does not.</para>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_post_interceptor;">POST Interceptor</ulink> adds menu items to toggle whether the script is active.</para></listitem>
</itemizedlist>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="api.gmregistermenucommand"/></para></listitem>
</itemizedlist>
</section> <!-- advanced.registermenucommand -->

<section id="advanced.xmlhttprequest">
<?dbhtml filename="advanced/gm_xmlhttprequest.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Greasemonkey defines a function, <function>GM_xmlhttpRequest</function>, that allows user scripts to <constant>GET</constant> data from any &url; or <constant>POST</constant> data to any &url;.</para>
</abstract>
</sectioninfo>
<title>Integrating data from other sites</title>
<para>See <xref linkend="api.gmxmlhttprequest"/> for more details and examples.</para>
<para>This function was introduced in Greasemonkey 0.2.6.  You should <link linkend="pattern.test">test whether it exists</link> and degrade gracefully if it does not.</para>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_librarylookup;">LibraryLookup</ulink> integrates <ulink url="&url_amazon;">Amazon.com</ulink> with your local library.</para></listitem>
<listitem><para><ulink url="&url_annotate_google;">Annotate Google</ulink> integrates <ulink url="&url_google;">Google</ulink> and <ulink url="&url_delicious;">del.icio.us</ulink>.</para></listitem>
<listitem><para><ulink url="&url_bloglines_tweaks;">Bloglines Tweaks</ulink> adds an <guibutton>Expand</guibutton> button to article summaries in <ulink url="&url_bloglines;">Bloglines</ulink> to retrieve and display the full article.</para></listitem>
<listitem><para><ulink url="&url_flick_batch;">Flick Batch Enhancer</ulink> uses <function>GM_xmlhttpRequest</function> to add features to <ulink url="&url_flickr;">Flickr</ulink> using Flickr's own &rest; API.</para></listitem>
<listitem><para><ulink url="&url_hide_google_redirects;">Hide Google Redirects</ulink> reprograms <ulink url="&url_google_searchhistory;">Google Personal Search History</ulink> to use normal <sgmltag>&lt;a href="..."&gt;</sgmltag> links, but still track clicks by calling <function>GM_xmlhttpRequest</function> on the appropriate tracking &url;.</para></listitem>
</itemizedlist>
</section> <!-- advanced.xmlhttprequest -->

<section id="advanced.compiler">
<?dbhtml filename="advanced/compiler.html"?>
<sectioninfo>
<abstract>
<title/>
<para>Has your user script <quote>outgrown</quote> Greasemonkey's architecture?  Does your user script need access to privileged Javascript functions, local files, or other Firefox features that are only available to full-fledged browser extensions?  You can turn your user script into a full-fledged <filename>XPI</filename> with just a few clicks, thanks to Adrian Holovaty's amazing <ulink url="&url_greasemonkey_compiler;">Greasemonkey compiler</ulink>!</para>
</abstract>
</sectioninfo>
<title>Compiling your user script into an extension</title>
<procedure>
<title>Compile Butler into a browser extension</title>
<step><para>Visit the <ulink url="&url_example_butler;">Butler user script source code</ulink>.  From the menu, select <menuchoice><shortcut><keycombo><keycap>Ctrl</keycap><keycap>A</keycap></keycombo></shortcut><guimenu><accel>E</accel>dit</guimenu><guimenuitem>Select <accel>A</accel>ll</guimenuitem></menuchoice> to copy the user script's source code to the clipboard.</para></step>
<step><para>Visit the <ulink url="&url_greasemonkey_compiler;">Greasemonkey compiler</ulink>.</para></step>
<step><para>Go to the <guilabel>Javascript</guilabel> field.  From the menu, select <menuchoice><shortcut><keycombo><keycap>Ctrl</keycap><keycap>V</keycap></keycombo></shortcut><guimenu><accel>E</accel>dit</guimenu><guimenuitem><accel>P</accel>aste</guimenuitem></menuchoice> to paste the Butler user script source code.</para></step>
<step><para>In the <guilabel>Creator</guilabel> field, enter <userinput>Mark Pilgrim</userinput>.</para></step>
<step><para>In the <guilabel>Version</guilabel> field, enter the current version of the Butler user script (&butlerversion; as of this writing, but check the script's <link linkend="first.metadata">metadata section</link> for the actual version).</para></step>
<step><para>Open a new window or tab and visit <ulink url="&url_guid_generator;">GUID Generator</ulink> to generate a random GUID.  Copy the GUID to the clipboard, including the curly braces.</para></step>
<step><para>Switch back to the <interface role="windowtitle">Greasemonkey compiler</interface> page.  In the <guilabel>GUID</guilabel> field, paste the GUID you got from the GUID Generator.</para></step>
<step><para>In the <guilabel>Homepage</guilabel> field, enter <userinput><systemitem>&url_butlerhomepage;</systemitem></userinput>.</para></step>
<step><para>Click <guibutton>Create the Firefox extension</guibutton>.  Firefox should pop up a dialog titled <interface role="windowtitle">Opening butler.xpi</interface>.  Select <guibutton>Save to disk</guibutton> and select a directory.</para></step>
</procedure>
<para>Tada!  You now have a version of Butler as a browser extension.  Before you install the Butler extension, you should first <link linkend="procedure.manage.userscripts">disable the Butler user script</link> and verify that it is disabled by searching for something on <ulink url="&url_google;">Google</ulink>.  Then install the Butler extension by selecting <menuchoice><guimenu><accel>F</accel>ile</guimenu><guimenuitem><accel>O</accel>pen...</guimenuitem></menuchoice> and selecting the <filename>butler.xpi</filename> file you created with the Greasemonkey compiler.  Be sure to restart your browser to finish the installation.</para>
<para>An <filename>.xpi</filename> file is really just a ZIP archive with a certain directory structure.  You can use any ZIP program (such as <ulink url="&url_7zip;">7-zip</ulink> for Windows or <ulink url="&url_stuffit;">Stuffit Expander</ulink> for Mac OS X) to decompress the archive and look at the files that constitute the browser extension.</para>
<informalexample>
<screen>butler.xpi
|
+-- install.rdf
|
+-- chrome/
    |
    +-- butler/
        |
        +-- content/
            |
            +-- browser.xul
            |
            +-- contents.rdf
            |
            +-- javascript.js</screen>
<para>There are four files involved.  The two RDF files are mostly Firefox boilerplate.  The other two contain the actual code.</para>
<variablelist>
<varlistentry>
<term><filename>install.rdf</filename></term>
<listitem><para>Metadata about the extension itself, including name, version, description, and compatible versions of Firefox.</para></listitem>
</varlistentry>
<varlistentry>
<term><filename>browser.xul</filename></term>
<listitem><para>Bootstrap code that checks the current &url; against the script's <literal>@include</literal> and <literal>@exclude</literal> parameters, and then injects and executes the script.</para></listitem>
</varlistentry>
<varlistentry>
<term><filename>contents.rdf</filename></term>
<listitem><para>More metadata, Firefox boilerplate.</para></listitem>
</varlistentry>
<varlistentry>
<term><filename>javascript.js</filename></term>
<listitem><para>The original user script's source code.</para></listitem>
</varlistentry>
</variablelist>
</informalexample>
<para>Basically, the Greasemonkey compiler creates a really, really stripped down version of Greasemonkey that has no user interface and automatically loads a single user script on the appropriate &url;s.  But now you have all the source files, and you can do anything you want: create custom dialogs, modify preference panes, register menu items outside the <menuchoice><guimenuitem>User Script <accel>C</accel>ommands</guimenuitem></menuchoice> menu... go wild!</para>
<itemizedlist role="furtherreading">
<title>Further reading</title>
<listitem><para><ulink url="&url_extension_developers_extension;">Extension Developer's Extension</ulink> is invaluable for debugging and testing Firefox extensions.</para></listitem>
</itemizedlist>

</section>

</chapter> <!-- advanced -->

<reference id="api">
<?dbhtml filename="api/index.html"?>
<title>Greasemonkey API Reference</title>

<refentry id="api.gmlog">
<?dbhtml filename="api/gm_log.html"?>
<refmeta>
<refentrytitle>GM_log</refentrytitle>
</refmeta>
<refnamediv>
<refname>GM_log</refname>
<refpurpose>log messages to the JavaScript Console</refpurpose>
</refnamediv>
<refsynopsisdiv>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef>function <function>GM_log</function></funcdef>
<paramdef><parameter>message</parameter></paramdef>
</funcprototype>
</funcsynopsis>
</refsynopsisdiv>
<refsection>
<title>Description</title>
<para><function>GM_log</function> places output in the JavaScript Console.  It is primarily used for debugging purposes.</para>
</refsection>
<refsection>
<title>History</title>
<para><function>GM_log</function> was introduced in Greasemonkey 0.3.</para>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="debug.gmlog"/></para></listitem>
<listitem><para><xref linkend="debug.console"/></para></listitem>
</itemizedlist>
</refsection>
</refentry> <!-- api.gmlog -->

<refentry id="api.gmgetvalue">
<?dbhtml filename="api/gm_getvalue.html"?>
<refmeta>
<refentrytitle>GM_getValue</refentrytitle>
</refmeta>
<refnamediv>
<refname>GM_getValue</refname>
<refpurpose>get script-specific configuration value</refpurpose>
</refnamediv>
<refsynopsisdiv>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef><replaceable>returntype</replaceable> <function>GM_getValue</function></funcdef>
<paramdef><parameter>key</parameter></paramdef>
<paramdef><parameter>defaultValue</parameter></paramdef>
</funcprototype>
</funcsynopsis>
</refsynopsisdiv>
<refsection>
<title>Description</title>
<para><function>GM_getValue</function> retrieves a script-specific configuration value.  The return value may be a string, boolean, or integer.  The <parameter>key</parameter> argument is a string of no fixed format.  The <parameter>defaultValue</parameter> argument is optional; if present, it will be returned if the requested <parameter>key</parameter> does not exist.  If no <parameter>defaultValue</parameter> is given and the requested <parameter>key</parameter> does not exist, <function>GM_getValue</function> will return <returnvalue>undefined</returnvalue>.</para>
<para>Greasemonkey configuration values are similar to browser cookies, but there are important differences.  Both are stored on the local machine, but while cookies are domain-specific and can only be accessed from their originating domain, Greasemonkey configuration values are script-specific and can only be accessed by the user script that created them (regardless of the address the user script is currently running on).  And unlike cookies, configuration values are never transmitted to remote servers.</para>
<tip>
<title/>
<para>You can see all the stored configuration values by visiting <systemitem>about:config</systemitem> and filtering on <literal>greasemonkey.scriptvals</literal>.</para>
</tip>
</refsection>
<refsection>
<title>History</title>
<para><function>GM_getValue</function> was introduced in Greasemonkey 0.3.</para>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="api.gmsetvalue"/></para></listitem>
</itemizedlist>
</refsection>
</refentry> <!-- api.gmgetvalue -->

<refentry id="api.gmsetvalue">
<?dbhtml filename="api/gm_setvalue.html"?>
<refmeta>
<refentrytitle>GM_setValue</refentrytitle>
</refmeta>
<refnamediv>
<refname>GM_setValue</refname>
<refpurpose>set script-specific configuration value</refpurpose>
</refnamediv>
<refsynopsisdiv>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef>function <function>GM_setValue</function></funcdef>
<paramdef><parameter>key</parameter></paramdef>
<paramdef><parameter>value</parameter></paramdef>
</funcprototype>
</funcsynopsis>
</refsynopsisdiv>
<refsection>
<title>Description</title>
<para><function>GM_setValue</function> stores a script-specific configuration value.  The <parameter>key</parameter> argument is a string of no fixed format.  The <parameter>value</parameter> argument can be a string, boolean, or integer.  Both arguments are required.</para>
<para>Greasemonkey configuration values are similar to browser cookies, but there are important differences.  Both are stored on the local machine, but while cookies are domain-specific and can only be accessed from their originating domain, Greasemonkey configuration values are script-specific and can only be accessed by the user script that created them (regardless of the address the user script is currently running on).  And unlike cookies, configuration values are never transmitted to remote servers.</para>
</refsection>
<refsection>
<title>History</title>
<para><function>GM_getValue</function> was introduced in Greasemonkey 0.3.</para>
<itemizedlist role="seealso">
<title>See also</title>
<listitem><para><xref linkend="api.gmgetvalue"/></para></listitem>
</itemizedlist>
</refsection>
</refentry> <!-- api.gmsetvalue -->

<refentry id="api.gmregistermenucommand">
<?dbhtml filename="api/gm_registermenucommand.html"?>
<refmeta>
<refentrytitle>GM_registerMenuCommand</refentrytitle>
</refmeta>
<refnamediv>
<refname>GM_registerMenuCommand</refname>
<refpurpose>add a menu item to the <guisubmenu>User Script <accel>C</accel>ommands</guisubmenu> submenu</refpurpose>
</refnamediv>
<refsynopsisdiv>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef>function <function>GM_registerMenuCommand</function></funcdef>
<paramdef><parameter>menuText</parameter></paramdef>
<paramdef><parameter>callbackFunction</parameter></paramdef>
</funcprototype>
</funcsynopsis>
</refsynopsisdiv>
<refsection>
<title>Description</title>
<para><function>GM_registerMenuCommand</function> adds a menu item to the <menuchoice><guimenu><accel>T</accel>ools</guimenu><guisubmenu>User Script <accel>C</accel>ommands</guisubmenu></menuchoice> menu.  The <parameter>menuText</parameter> argument is a string, the text of the menu item to add.  The <parameter>callbackFunction</parameter> argument is a function object.  When the menu item is selected, the <function>callbackFunction</function> function is called.</para>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef>function <function><replaceable>callbackFunction</replaceable></function></funcdef>
<paramdef><parameter>e</parameter></paramdef>
</funcprototype>
</funcsynopsis>
<para>The <parameter>e</parameter> parameter is the menu selection event.  I'm not sure if this is useful for anything.</para>
</refsection>
<refsection>
<title>Bugs</title>
<para>There is no way to set a menu accelerator key.  Calling <function>GM_registerMenuCommand('Some &amp;menu text', <replaceable>myFunction</replaceable>)</function> will create a menu item titled <quote><literal>Some &amp;menu text</literal></quote>.  (<ulink url="http://bugzilla.mozdev.org/show_bug.cgi?id=10090">Bug 10090</ulink>)</para>
</refsection>
<refsection>
<title>History</title>
<para><function>GM_registerMenuCommand</function> was introduced in Greasemonkey 0.2.6.</para>
</refsection>
</refentry> <!-- api.gmregistermenucommand -->

<refentry id="api.gmxmlhttprequest">
<?dbhtml filename="api/gm_xmlhttprequest.html"?>
<refmeta>
<refentrytitle>GM_xmlhttpRequest</refentrytitle>
</refmeta>
<refnamediv>
<refname>GM_xmlhttpRequest</refname>
<refpurpose>make an arbitrary &http; request</refpurpose>
</refnamediv>
<refsynopsisdiv>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef><function>GM_xmlhttpRequest</function></funcdef>
<paramdef><parameter>details</parameter></paramdef>
</funcprototype>
</funcsynopsis>
</refsynopsisdiv>
<refsection>
<title>Description</title>
<para><function>GM_xmlhttpRequest</function> makes an arbitrary &http; request.  The <parameter>details</parameter> argument is an object that can contain up to seven fields.</para>
<variablelist>
<varlistentry>
<term>method</term>
<listitem><para>a string, the &http; method to use on this request.  <emphasis>Required.</emphasis>  Generally <constant>GET</constant>, but can be any &http; verb, including <literal>POST</literal>, <literal>PUT</literal>, and <literal>DELETE</literal>.</para></listitem>
</varlistentry>
<varlistentry>
<term>url</term>
<listitem><para>a string, the &url; to use on this request.  <emphasis>Required.</emphasis></para></listitem>
</varlistentry>
<varlistentry>
<term>headers</term>
<listitem><para>an associative array of &http; headers to include on this request.  Optional, defaults to an empty array.  Example:</para>
<informalexample>
<programlisting><![CDATA[headers: {'User-Agent': 'Mozilla/4.0 (compatible) Greasemonkey',
          'Accept': 'application/atom+xml,application/xml,text/xml'}]]></programlisting>
</informalexample>
</listitem>
</varlistentry>
<varlistentry>
<term>data</term>
<listitem><para>a string, the body of the &http; request.  Optional, defaults to an empty string.  If you are simulating posting a form (<parameter>method</parameter> == <literal>'POST'</literal>), you must include a <literal>Content-type</literal> of <literal>'application/x-www-form-urlencoded'</literal> in the <parameter>headers</parameter> field, and include the &url;-encoded form data in the <parameter>data</parameter> field.</para></listitem>
</varlistentry>
<varlistentry>
<term>&onload;</term>
<listitem><para>a function object, the callback function to be called when the request has finished successfully.</para></listitem>
</varlistentry>
<varlistentry>
<term>&onerror;</term>
<listitem><para>a function object, the callback function to be called if an error occurs while processing the request.</para></listitem>
</varlistentry>
<varlistentry>
<term>&onreadystatechange;</term>
<listitem><para>a function object, the callback function to be called repeatedly while the request is in progress.</para></listitem>
</varlistentry>
</variablelist>

<refsection>
<title>&onload; callback</title>
<para>The callback function for &onload; takes a single parameter, <parameter>responseDetails</parameter>.</para>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef>function <function>onloadCallback</function></funcdef>
<paramdef><parameter>responseDetails</parameter></paramdef>
</funcprototype>
</funcsynopsis>
<para><parameter>responseDetails</parameter> is an object with five fields.</para>
<variablelist>
<varlistentry>
<term>status</term>
<listitem><para>an integer, the &http; status code of the response.  <constant>200</constant> means the request completed normally.</para></listitem>
</varlistentry>
<varlistentry>
<term>statusText</term>
<listitem><para>a string, the &http; status text.  Status text is server-dependent.</para></listitem>
</varlistentry>
<varlistentry>
<term>responseHeaders</term>
<listitem><para>a string, the &http; headers included in the response.</para></listitem>
</varlistentry>
<varlistentry>
<term>responseText</term>
<listitem><para>a string, the body of the response.</para></listitem>
</varlistentry>
<varlistentry>
<term>readyState</term>
<listitem><para>unused</para></listitem>
</varlistentry>
</variablelist>
</refsection>

<refsection>
<title>&onerror; callback</title>
<para>The callback function for &onerror; takes a single parameter, <parameter>responseDetails</parameter>.</para>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef>function <function><replaceable>onerrorCallback</replaceable></function></funcdef>
<paramdef><parameter>responseDetails</parameter></paramdef>
</funcprototype>
</funcsynopsis>
<para><parameter>responseDetails</parameter> is an object with five fields.</para>
<variablelist>
<varlistentry>
<term>status</term>
<listitem><para>an integer, the &http; error code of the response.  <constant>404</constant> means the page was not found.</para></listitem>
</varlistentry>
<varlistentry>
<term>statusText</term>
<listitem><para>a string, the &http; status text.  Status text is server-dependent.</para></listitem>
</varlistentry>
<varlistentry>
<term>responseHeaders</term>
<listitem><para>a string, the &http; headers included in the response.</para></listitem>
</varlistentry>
<varlistentry>
<term>responseText</term>
<listitem><para>a string, the body of the response.  The body of an &http; error page is server-dependent.</para></listitem>
</varlistentry>
<varlistentry>
<term>readyState</term>
<listitem><para>unused</para></listitem>
</varlistentry>
</variablelist>

</refsection>

<refsection>
<title>&onreadystatechange; callback</title>
<para>The callback function for &onreadystatechange; is called repeatedly while the request is in progress.  It takes a single parameter, <parameter>responseDetails</parameter>.</para>
<funcsynopsis>
<funcsynopsisinfo language="Javascript"/>
<funcprototype>
<funcdef>function <function>onreadystatechangeCallback</function></funcdef>
<paramdef><parameter>responseDetails</parameter></paramdef>
</funcprototype>
</funcsynopsis>
<para><parameter>responseDetails</parameter> is an object with five fields.  The <property>responseDetails.readyState</property> denotes what stage the request is currently in.</para>
<variablelist>
<varlistentry>
<term>status</term>
<listitem><para>an integer, the &http; status code of the response.  This will be <constant>0</constant> when <property>responseDetails.readyState</property> <literal>&lt;</literal> <constant>4</constant>.</para></listitem>
</varlistentry>
<varlistentry>
<term>statusText</term>
<listitem><para>a string, the &http; status text.  This will be an empty string when <property>responseDetails.readyState</property> <literal>&lt;</literal> <constant>4</constant>.</para></listitem>
</varlistentry>
<varlistentry>
<term>responseHeaders</term>
<listitem><para>a string, the &http; headers included in the response.  This will be an empty string when <property>responseDetails.readyState</property> <literal>&lt;</literal> <constant>4</constant>.</para></listitem>
</varlistentry>
<varlistentry>
<term>responseText</term>
<listitem><para>a string, the body of the response.  This will be an empty string when <property>responseDetails.readyState</property> <literal>&lt;</literal> <constant>4</constant>.</para></listitem>
</varlistentry>
<varlistentry>
<term>readyState</term>
<listitem><para>an integer, the stage of the &http; request.</para>
<variablelist>
<varlistentry>
<term><constant>1</constant></term>
<listitem><para>loading.  The request is being prepared.</para></listitem>
</varlistentry>
<varlistentry>
<term><constant>2</constant></term>
<listitem><para>loaded.  The request is ready to be sent to the server, but nothing has been sent yet.</para></listitem>
</varlistentry>
<varlistentry>
<term><constant>3</constant></term>
<listitem><para>interactive.  The request has been sent and the client is waiting for the server to finish sending data.</para></listitem>
</varlistentry>
<varlistentry>
<term><constant>4</constant></term>
<listitem><para>complete.  The request is completed and all response data is available in other fields.</para></listitem>
</varlistentry>
</variablelist>
</listitem>
</varlistentry>
</variablelist>
</refsection>

</refsection>

<refsection>
<title>Examples</title>
<para>The following code fetches the Atom feed from <ulink url="&url_greaseblog;"/> and displays an alert with the results.</para>
<informalexample>
<programlisting><![CDATA[GM_xmlhttpRequest({
    method: 'GET',
    url: 'http://greaseblog.blogspot.com/atom.xml',
    headers: {
        'User-agent': 'Mozilla/4.0 (compatible) Greasemonkey',
        'Accept': 'application/atom+xml,application/xml,text/xml',
    },
    onload: function(responseDetails) {
        alert('Request for Atom feed returned ' + responseDetails.status +
              ' ' + responseDetails.statusText + '\n\n' +
              'Feed data:\n' + responseDetails.responseText);
    }
});]]></programlisting>
</informalexample>
</refsection>

<refsection>
<title>Bugs</title>
<para>The &onreadystatechange; callback does not work properly with <property>readyState</property> <literal>&lt;</literal> <constant>4</constant>.</para>
</refsection>

<refsection>
<title>Notes</title>
<para>Unlike the <classname>XMLHttpRequest</classname> object, <function>GM_xmlhttpRequest</function> is not restricted to the current domain; it can <constant>GET</constant> or <constant>POST</constant> data from any &url;.</para>
</refsection>

<refsection>
<title>History</title>
<para><function>GM_xmlhttpRequest</function> was introduced in Greasemonkey 0.2.6.</para>
<itemizedlist role="furtherreading">
<title>Futher reading</title>
<listitem><para><ulink url="&url_mozillaxmlhttprequest;"><classname>XMLHttpRequest</classname> support in Mozilla</ulink></para></listitem>
<listitem><para><ulink url="&url_iexmlhttprequest;"><classname>XMLHttpRequest</classname> support in Internet Explorer</ulink></para></listitem>
<listitem><para><ulink url="&url_safarixmlhttprequest;"><classname>XMLHttpRequest</classname> support in Safari</ulink></para></listitem>
<listitem><para><ulink url="&url_httpstatuscodes;">&http; status codes</ulink></para></listitem>
<listitem><para><ulink url="&url_rfc2616;">RFC 2616</ulink></para></listitem>
</itemizedlist>
</refsection>
</refentry> <!-- api.gmxmlhttprequest -->

</reference> <!-- api -->

<appendix id="furtherreading">
<?dbhtml filename="appendix/furtherreading.html"?>
<title>List of <quote>further reading</quote> links</title>
<tip id="tip.furtherreading">
<title/>
<para>Whenever you see a list of <quote>further reading</quote> links throughout this book, you can click on the <quote>Further reading</quote> header to jump to the list of all further reading links.</para>
</tip>
<para>
</para>
</appendix>

<appendix id="tips">
<?dbhtml filename="appendix/tips.html"?>
<title>List of tips</title>
<tip id="tip.tips">
<title/>
<para>Whenever you see a tip or warning throughout this book, you can click on the tip icon to jump to the list of all tips.</para>
</tip>
<para>
</para>
</appendix>

<appendix id="examples">
<?dbhtml filename="appendix/examples.html"?>
<title>List of examples</title>
<para>
</para>
</appendix>

<appendix id="procedures">
<?dbhtml filename="appendix/procedures.html"?>
<title>List of procedures</title>
<tip id="tip.videos">
<title/>
<para>Whenever you see a video link throughout this book, you can click on the <inlinegraphic fileref="&url_images;radio-star.png"/> icon to jump to the list of all videos.</para>
</tip>
<para>
</para>
</appendix>

<appendix id="revhistory">
<?dbhtml filename="appendix/history.html"?>
<title>Revision history</title>
<para>
</para>
</appendix>

<appendix id="colophon">
<?dbhtml filename="appendix/colophon.html"?>
<title>About this book</title>
<para>I wrote this book in <ulink url="&url_docbook;" type="DocBook home page">&docbook; &xml;</ulink> using <ulink url="&url_emacs;" type="The One True Editor">&emacs;</ulink>.  <ulink url="&url_saxon;" type="SAXON home page">&saxon;</ulink> converted it to &html; (with a customized version of <ulink url="&url_docbookxsl;" type="DocBook XSL home page">Norman Walsh's &xsl; stylesheets</ulink>).  <ulink url="&url_htmldoc;" type="HTMLDOC home page">&htmldoc;</ulink> converted it to &pdf;.  <ulink url="&url_w3m;" type="w3m home page">&w3m;</ulink> converted it to plain text.  <ulink url="&url_plucker;" type="Plucker home page">Plucker Distiller</ulink> converted it to a Palm OS&trade; database so you can read it on mobile devices.  An <ulink url="&url_ant;">Ant</ulink> script automates the entire process.</para>

<para>I created the supplementary videos with <ulink url="&url_camstudio;" type="left homeless after being bought out and killed">CamStudio</ulink> and <ulink url="&url_tmpgenc;" type="&url_tmpgenc;">TMPGEnc</ulink>.</para>

<para>Dean Edwards wrote <ulink url="&url_mozbehaviors;" type="wicked, wicked cool">js-highlight</ulink>, which provides automatic syntax highlighting of the Javascript examples.</para>

<para>If you're interested in learning more about &docbook; for technical writing, you can <ulink url="&url_download_xml;" type="Download the book's source files">download the &xml; source</ulink>, which includes the version of &docbook; and all the &xsl; stylesheets and build scripts I use to create the different versions of the book.  You should also read the canonical book, <ulink url="&url_docbook_tdg;" type="Read DocBook: The Definitive Guide online"><citetitle pubwork="book">&docbook;: The Definitive Guide</citetitle></ulink>.  You can also subscribe to the <ulink url="&url_docbook_lists;" type="DocBook and DocBook-Apps home page">&docbook; mailing lists</ulink>.</para>
</appendix>

&gpl;
</book>